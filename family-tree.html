<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
    <title>Gia phả dòng họ Nguyễn Bá - xã Hoàng Sơn, huyện Nông Cống, tỉnh Thanh Hóa</title>
    <link rel="stylesheet" href="family-tree.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Thay OrgChart.js bằng D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- Thêm Google API Client và Google Picker API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
            box-sizing: border-box;
        }
        
        .content {
            padding: 15px 0;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            padding: 10px 0;
            margin-bottom: 15px;
            color: #0066cc;
            text-decoration: none;
            font-weight: bold;
            font-size: 16px;
        }
        
        .back-link i {
            margin-right: 8px;
        }
        
        #family-tree-container {
            width: 100%;
            height: 85vh; /* Sử dụng viewport height để tối ưu cho mobile */
            overflow: hidden;
            position: relative;
            border-radius: 5px;
            background-color: #f8f9fa;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* CSS cho Node */
        .family-node {
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            background-color: white;
            transition: all 0.3s ease;
        }
        
        .family-node.male {
            border-left: 5px solid #0066cc;
        }
        
        .family-node.female {
            border-left: 5px solid #e91e63;
        }
        
        .node-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 8px;
            border: 3px solid #f0f5ff;
        }
        
        /* D3.js specific styles */
        .node {
            cursor: pointer;
        }

        .node rect {
            fill: white;
            stroke-width: 3px;
            rx: 5;
            ry: 5;
        }

        .node.male rect {
            stroke: #0066cc;
        }

        .node.female rect {
            stroke: #e91e63;
        }

        .node.couple rect {
            stroke: #E4E4E4;
        }

        .node.couple.male rect {
            stroke: #0066cc;
        }

        .node.couple.female rect {
            stroke: #e91e63;
        }

        .node text {
            font-family: Arial, sans-serif;
            text-anchor: middle;
            font-size: 12px !important;
            /* Ngăn text bị xuống dòng */
            white-space: nowrap;
            /* Ngăn text bị overflow */
            overflow: hidden;
            /* Cắt bớt text quá dài */
            text-overflow: ellipsis;
        }

        .node image {
            border-radius: 50%;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
        }

        .marriage-link {
            fill: none;
            stroke: #FF9999;
            stroke-width: 2px;
            stroke-dasharray: 4;
        }

        .node-button {
            cursor: pointer;
        }
        
        /* Tùy chỉnh cho mobile */
        @media (max-width: 768px) {
            #family-tree-container {
                height: 80vh;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
            
            .view-tabs button {
                font-size: 14px;
                padding: 8px;
            }
            
            .zoom-controls {
                bottom: 10px !important;
                right: 10px !important;
            }
        }
        
        /* Tùy chỉnh cho modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }
        
        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 10px;
        }
        
        .close-modal:hover {
            color: black;
        }
        
        .loading-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
        }
        
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tùy chỉnh giao diện D3.js */
        [data-boc-name] {
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }
        
        [data-boc-birth] {
            font-size: 12px;
            color: #666;
        }
        
        .relation-list {
            margin: 10px 0;
        }
        
        .relation-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .view-details-btn {
            display: inline-block;
            margin-top: 5px;
            font-size: 12px;
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
        }
        
        /* Tùy chỉnh đường kết nối vợ chồng */
        [data-boc-layout-path-line-marriage] {
            stroke: #FF9999;
            stroke-width: 2px;
            stroke-dasharray: 4;
        }
        
        /* Ẩn node kết nối giữa vợ chồng */
        [data-boc-tags~=partner-connection] {
            opacity: 0;
        }
        
        /* Tăng khoảng cách giữa vợ chồng */
        .partner-node {
            margin: 0 15px;
        }

        /* Thêm CSS cho single nodes */
        [data-boc-tags~=male] rect {
            stroke: #0066cc !important;
            stroke-width: 3px !important;
        }

        [data-boc-tags~=female] rect {
            stroke: #e91e63 !important;
            stroke-width: 3px !important;
        }

        /* Thêm style cho avatar người chính trong couple nodes */
        .couple-person-avatar {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            z-index: 100;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* CSS cho chức năng upload ảnh */
        .upload-section {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        
        .upload-btn {
            background-color: #4CAF50;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .upload-btn:hover {
            background-color: #45a049;
        }
        
        .upload-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .upload-progress {
            margin-top: 10px;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-top: 5px;
        }
        
        .progress-bar-fill {
            height: 10px;
            background-color: #4CAF50;
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s;
        }
        
        .upload-result {
            margin-top: 10px;
            display: none;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .file-input {
            display: none;
        }
        
        .select-file-btn {
            background-color: #2196F3;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .select-file-btn:hover {
            background-color: #0b7dda;
        }
        
        .file-name {
            margin-top: 5px;
            font-size: 13px;
            color: #555;
        }
        
        .error-message {
            color: #e74c3c;
            margin-top: 10px;
            display: none;
        }
        
        .success-message {
            color: #2ecc71;
            margin-top: 10px;
            display: none;
        }

        /* Tối ưu các tab chuyển đổi */
        .view-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap; /* Cho phép xuống dòng trên mobile */
        }
        
        .view-tab {
            padding: 10px 15px;
            background-color: #f8f9fa;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .view-tab:hover {
            background-color: #e9ecef;
        }
        
        .view-tab.active {
            border-bottom: 3px solid #0066cc;
            font-weight: bold;
            background-color: #fff;
        }
        
        /* Tối ưu danh sách */
        .family-list-container {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 20px;
            min-height: 500px;
        }
        
        .list-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .sort-controls,
        .filter-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .sort-controls select,
        .filter-controls input {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        #search-btn {
            background-color: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
        }
        
        /* Tối ưu hiển thị danh sách */
        .family-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .family-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .family-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .family-card.male {
            border-left: 5px solid #0066cc;
        }
        
        .family-card.female {
            border-left: 5px solid #e91e63;
        }
        
        .family-card-content {
            padding: 15px;
        }
        
        .family-card-header {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .family-card-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #f0f5ff;
        }
        
        .family-card-info h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        
        .family-card-info p {
            margin: 0;
            font-size: 13px;
            color: #666;
        }
        
        .family-card-relations {
            font-size: 13px;
            color: #555;
        }
        
        .relation-count {
            margin-right: 15px;
        }
        
        .generation-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #0066cc;
            color: white;
            border-radius: 20px;
            padding: 3px 10px;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* CSS cho phần phân trang */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .pagination-controls button {
            padding: 8px 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .pagination-controls button:hover:not(:disabled) {
            background-color: #e9ecef;
        }
        
        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #page-info {
            font-size: 14px;
            color: #555;
        }
        
        /* Media queries cho giao diện mobile */
        @media (max-width: 768px) {
            #family-tree-container {
                height: 80vh;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
            
            .view-tab {
                font-size: 14px;
                padding: 8px;
            }
            
            .zoom-controls {
                bottom: 10px !important;
                right: 10px !important;
            }
            
            .view-tab {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .list-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .sort-controls, 
            .filter-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .sort-controls select {
                max-width: 45%;
            }
            
            .filter-controls input {
                flex-grow: 1;
            }
            
            .family-list {
                grid-template-columns: 1fr;
            }
            
            .pagination-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
        <div class="container">
        <section class="content">
            <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Quay lại trang chủ</a>

            <!-- Thêm tab để chuyển đổi giữa chế độ xem -->
            <div class="view-tabs">
                <button id="tree-view-btn" class="view-tab active"><i class="fas fa-sitemap"></i> Xem dạng cây</button>
                <button id="list-view-btn" class="view-tab"><i class="fas fa-list"></i> Xem dạng danh sách</button>
            </div>

            <div id="loading-indicator" class="loading-indicator">
                <div class="loading-spinner"></div>
                <p>Đang tải dữ liệu gia phả...</p>
            </div>

            <div id="family-tree-container" class="family-tree-container" style="display: none">
                <div id="family-tree" class="chart"></div>
            </div>

            <!-- Thêm phần danh sách với phân trang -->
            <div id="family-list-container" class="family-list-container" style="display: none">
                <div class="list-controls">
                    <div class="sort-controls">
                        <label for="sort-field">Sắp xếp theo:</label>
                        <select id="sort-field">
                            <option value="id">ID</option>
                            <option value="generation">Thế hệ</option>
                            <option value="birthDate" selected>Ngày sinh</option>
                            <option value="name">Tên</option>
                        </select>
                        <select id="sort-order">
                            <option value="desc" selected>Mới đến cũ</option>
                            <option value="asc">Cũ đến mới</option>
                        </select>
                    </div>
                    <div class="filter-controls">
                        <input type="text" id="search-input" placeholder="Tìm kiếm...">
                        <button id="search-btn"><i class="fas fa-search"></i></button>
                    </div>
                </div>
                
                <div id="family-list" class="family-list">
                    <!-- Danh sách người sẽ được thêm vào đây -->
                </div>
                
                <div class="pagination-controls">
                    <button id="prev-page" disabled><i class="fas fa-chevron-left"></i> Trang trước</button>
                    <span id="page-info">Trang <span id="current-page">1</span> / <span id="total-pages">1</span></span>
                    <button id="next-page" disabled>Trang sau <i class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <div id="empty-state" class="empty-state" style="display: none">
                <i class="fas fa-users-slash"></i>
                <h3>Chưa có dữ liệu gia phả</h3>
                <p>Dữ liệu gia phả đang được cập nhật. Vui lòng quay lại sau.</p>
        </div>
    </section>
    </div>

    <div id="person-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="close-modal">&times;</span>
            <div id="person-detail-content">
                <!-- Chi tiết người sẽ được thêm vào đây -->
            </div>
        </div>
    </div>

    <script>
        // Thiết lập cấu trúc dữ liệu cho gia phả
        let familyData = [];
        let familyChart = null;
        let formattedChartData = null; // Biến toàn cục để lưu dữ liệu đã định dạng
        
        // Biến cho phân trang
        const ITEMS_PER_PAGE = 25;
        let currentPage = 1;
        let filteredData = [];
        let currentSortField = 'birthDate';
        let currentSortOrder = 'desc';
        let currentSearchTerm = '';

        // Thêm polyfill cho phương thức addPartnerAndParentNodes nếu nó không tồn tại trong OrgChart
        // Không cần thiết khi sử dụng D3.js
        /*
        if (OrgChart && !OrgChart.prototype.addPartnerAndParentNodes) {
            OrgChart.prototype.addPartnerAndParentNodes = function(nodeId, childrenIds, partnerData) {
                console.log("Polyfill cho addPartnerAndParentNodes được gọi");
                // Đây chỉ là một hàm giả để tránh lỗi
                // Chúng ta không cần thực hiện gì cả vì việc này đã được xử lý trong 
                // hàm convertToOrgChartFormat của chúng ta
                return;
            };
        }
        */

        // Lấy dữ liệu gia phả từ API hoặc dữ liệu mẫu
        async function getFamilyData() {
            try {
                console.log("Đang gọi API để lấy dữ liệu gia phả...");
                
                // Thêm timeout cho API call để tránh chờ quá lâu
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 giây timeout
                
                try {
                    const response = await fetch('/api/family', {
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`Lỗi khi lấy dữ liệu: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log(`Đã nhận ${data.length} người từ API`);
                    return data;
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    
                    // Nếu lỗi là do timeout hoặc network, hiển thị thông báo rõ ràng hơn
                    if (fetchError.name === 'AbortError') {
                        console.warn('API timeout sau 10 giây. Sử dụng dữ liệu mẫu.');
                        throw new Error('Kết nối API quá chậm. Đang sử dụng dữ liệu mẫu.');
                    } else {
                        console.warn('Lỗi khi gọi API:', fetchError.message);
                        throw fetchError;
                    }
                }
            } catch (error) {
                console.warn('Sử dụng dữ liệu mẫu do lỗi:', error.message);

                // Trả về dữ liệu mẫu đã có
                return [
                    {
                        id: '1',
                        name: 'Nguyễn Bá Cụ',
                        gender: 'male',
                        generation: 1,
                        birthDate: '1900-01-01',
                        deathDate: '1970-01-01',
                        spouses: ['100'],
                        children: ['2', '3', '4']
                    },
                    {
                        id: '100',
                        name: 'Nguyễn Thị Vợ Cụ',
                        gender: 'female',
                        generation: 1,
                        birthDate: '1905-01-01',
                        deathDate: '1975-01-01',
                        spouses: ['1'],
                        children: ['2', '3', '4']
                    },
                    {
                        id: '2',
                        name: 'Nguyễn Bá Trưởng',
                        gender: 'male',
                        generation: 2,
                        birthDate: '1930-01-01',
                        parents: ['1', '100'],
                        spouses: ['101'],
                        children: ['5', '6']
                    },
                    {
                        id: '101',
                        name: 'Nguyễn Thị Vợ Trưởng',
                        gender: 'female',
                        generation: 2,
                        birthDate: '1935-01-01',
                        spouses: ['2'],
                        children: ['5', '6']
                    },
                    {
                        id: '3',
                        name: 'Nguyễn Bá Thứ',
                        gender: 'male',
                        generation: 2,
                        birthDate: '1935-01-01',
                        parents: ['1', '100'],
                        spouses: ['102'],
                        children: ['7']
                    },
                    {
                        id: '102',
                        name: 'Nguyễn Thị Vợ Thứ',
                        gender: 'female',
                        generation: 2,
                        birthDate: '1940-01-01',
                        spouses: ['3'],
                        children: ['7']
                    },
                    {
                        id: '4',
                        name: 'Nguyễn Bá Út',
                        gender: 'male',
                        generation: 2,
                        birthDate: '1940-01-01',
                        parents: ['1', '100'],
                        spouses: ['103'],
                        children: ['8', '9']
                    },
                    {
                        id: '103',
                        name: 'Nguyễn Thị Vợ Út',
                        gender: 'female',
                        generation: 2,
                        birthDate: '1945-01-01',
                        spouses: ['4'],
                        children: ['8', '9']
                    },
                    {
                        id: '5',
                        name: 'Nguyễn Bá A',
                        gender: 'male',
                        generation: 3,
                        birthDate: '1960-01-01',
                        parents: ['2', '101']
                    },
                    {
                        id: '6',
                        name: 'Nguyễn Thị B',
                        gender: 'female',
                        generation: 3,
                        birthDate: '1965-01-01',
                        parents: ['2', '101']
                    },
                    {
                        id: '7',
                        name: 'Nguyễn Bá C',
                        gender: 'male',
                        generation: 3,
                        birthDate: '1965-01-01',
                        parents: ['3', '102']
                    },
                    {
                        id: '8',
                        name: 'Nguyễn Bá D',
                        gender: 'male',
                        generation: 3,
                        birthDate: '1970-01-01',
                        parents: ['4', '103']
                    },
                    {
                        id: '9',
                        name: 'Nguyễn Thị E',
                        gender: 'female',
                        generation: 3,
                        birthDate: '1975-01-01',
                        parents: ['4', '103']
                    }
                ];
            }
        }

        // Tạo danh sách node từ dữ liệu gia phả
        function formatFamilyData(familyDataArray) {
            // Tạo cấu trúc dữ liệu phù hợp với D3.js
            // D3.js sử dụng cấu trúc dạng cây phân cấp với nodes và links

            // Tìm thế hệ thấp nhất trong dữ liệu để xác định người gốc
            let minGeneration = Number.MAX_SAFE_INTEGER;
            familyDataArray.forEach(person => {
                if (person.generation && person.generation < minGeneration) {
                    minGeneration = person.generation;
                }
            });
            
            // Thiết lập root node (node gốc) dựa vào thế hệ thấp nhất tìm được
            const rootPersons = familyDataArray.filter(p => p.generation === minGeneration);
            
            if (rootPersons.length === 0) {
                console.error("Không tìm thấy người thế hệ gốc");
                return { root: null, nodeMap: new Map() };
            }
            
            console.log(`Đã tìm thấy ${rootPersons.length} người thuộc thế hệ gốc (thế hệ ${minGeneration})`);
            
            // Tạo một map lưu trữ tất cả các node để dễ dàng truy cập
            const nodeMap = new Map();
            
            // Tạo các node cơ bản từ dữ liệu người
            familyDataArray.forEach(person => {
                // Avatar mặc định nếu không có ảnh
                let photoUrl = person.photo;
                if (!photoUrl) {
                    if (person.gender === 'male') {
                        photoUrl = 'https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_1280.png';
                    } else {
                        photoUrl = 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png';
                    }
                }

                // Xử lý chuỗi ngày
                let lifespan = '';
                if (person.birthDate) {
                    const birthYear = new Date(person.birthDate).getFullYear();
                    if (person.deathDate) {
                        const deathYear = new Date(person.deathDate).getFullYear();
                        lifespan = `${birthYear} - ${deathYear}`;
                    } else {
                        lifespan = `Sinh năm ${birthYear}`;
                    }
                }

                // Tạo node mới
                        const node = {
                            id: person.id,
                            name: person.name,
                            img: photoUrl,
                            birth: lifespan,
                            gender: person.gender,
                            generation: person.generation,
                    data: person,  // Lưu toàn bộ dữ liệu gốc
                    children: []   // Sẽ được cập nhật sau
                };
                
                nodeMap.set(person.id, node);
            });
            
            // Xây dựng cấu trúc cây bằng cách thiết lập quan hệ cha-con
            familyDataArray.forEach(person => {
                if (!person.children || person.children.length === 0) return;
                
                const parentNode = nodeMap.get(person.id);
                if (!parentNode) return;
                
                // Thêm các con vào node cha
                person.children.forEach(childId => {
                    const childNode = nodeMap.get(childId);
                    if (childNode && !parentNode.children.includes(childNode)) {
                        // Chỉ thêm nếu node con tồn tại và chưa được thêm
                        parentNode.children.push(childNode);
                    }
                });
            });
            
            // Thiết lập node gốc từ người thế hệ thấp nhất
            const rootNode = nodeMap.get(rootPersons[0].id);
            
            // Xử lý các cặp vợ chồng
            familyDataArray.forEach(person => {
                if (!person.spouses || person.spouses.length === 0) return;
                
                const personNode = nodeMap.get(person.id);
                if (!personNode) return;
                
                // Đánh dấu là có vợ/chồng
                personNode.hasSpouse = true;
                
                // Thêm thông tin vợ/chồng vào node
                person.spouses.forEach(spouseId => {
                    const spouse = familyDataArray.find(p => p.id === spouseId);
                    if (!spouse) return;
                    
                    // Lưu thông tin vợ/chồng vào node hiện tại
                    if (!personNode.spouses) personNode.spouses = [];
                    
                    // Tạo thông tin vợ/chồng
                        let spousePhotoUrl = spouse.photo;
                        if (!spousePhotoUrl) {
                            if (spouse.gender === 'male') {
                                spousePhotoUrl = 'https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_1280.png';
                            } else {
                                spousePhotoUrl = 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png';
                            }
                        }

                        // Lifespan của vợ/chồng
                        let spouseLifespan = '';
                        if (spouse.birthDate) {
                            const birthYear = new Date(spouse.birthDate).getFullYear();
                            if (spouse.deathDate) {
                                const deathYear = new Date(spouse.deathDate).getFullYear();
                                spouseLifespan = `${birthYear} - ${deathYear}`;
                            } else {
                                spouseLifespan = `Sinh năm ${birthYear}`;
                            }
                        }

                    personNode.spouses.push({
                        id: spouse.id,
                        name: spouse.name,
                        img: spousePhotoUrl,
                        birth: spouseLifespan,
                        gender: spouse.gender
                    });
                });
            });
            
            return { root: rootNode, nodeMap: nodeMap };
        }

        // Hàm khởi tạo D3.js tree
        function initializeD3Tree(formattedData) {
            // Lưu dữ liệu đã định dạng vào biến toàn cục để sử dụng sau này
            formattedChartData = formattedData;
            
            // Xóa nội dung cũ
            d3.select("#family-tree").selectAll("*").remove();
            
            // Kích thước của container
            const width = document.getElementById('family-tree-container').offsetWidth;
            const height = document.getElementById('family-tree-container').offsetHeight;
            
            // Tạo SVG container
            const svg = d3.select("#family-tree")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${width / 2}, 50)`);
            
            // Tạo zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.1, 3])
                .on("zoom", (event) => {
                    svg.attr("transform", event.transform);
                });
            
            // Lấy SVG container
            const svgContainer = d3.select("#family-tree svg")
                .call(zoom)
                .on("dblclick.zoom", null);
                
            // Thiết lập zoom ban đầu để hiển thị toàn bộ cây
            svgContainer.call(zoom.scaleTo, 0.8);
            
            // Thêm nút điều khiển zoom
            const zoomControls = d3.select("#family-tree")
                .append("div")
                .attr("class", "zoom-controls")
                .style("position", "absolute")
                .style("bottom", "20px")
                .style("right", "20px")
                .style("display", "flex")
                .style("flex-direction", "column")
                .style("gap", "10px");
            
            zoomControls.append("button")
                .text("+")
                .style("width", "30px")
                .style("height", "30px")
                .style("font-size", "18px")
                .style("border-radius", "50%")
                .style("border", "1px solid #ccc")
                .style("background", "#fff")
                .style("cursor", "pointer")
                .on("click", () => {
                    svgContainer.transition().call(zoom.scaleBy, 1.3);
                });
            
            zoomControls.append("button")
                .text("-")
                .style("width", "30px")
                .style("height", "30px")
                .style("font-size", "18px")
                .style("border-radius", "50%")
                .style("border", "1px solid #ccc")
                .style("background", "#fff")
                .style("cursor", "pointer")
                .on("click", () => {
                    svgContainer.transition().call(zoom.scaleBy, 0.7);
                });
            
            // Tạo layout cây
            const treeLayout = d3.tree()
                .nodeSize([160, 40])  // Giảm từ [180, 40] xuống [160, 40]
                .separation((a, b) => {
                    // Xác định xem các node có phối ngẫu không
                    const aHasSpouse = a.data.hasSpouse && a.data.spouses && a.data.spouses.length > 0;
                    const bHasSpouse = b.data.hasSpouse && b.data.spouses && b.data.spouses.length > 0;
                    
                    // Kiểm tra xem các node có cùng cha mẹ không
                    if (a.parent === b.parent) {
                        // Tính toán vị trí trong danh sách anh em
                        const aSiblingIndex = a.parent.children.indexOf(a);
                        const bSiblingIndex = a.parent.children.indexOf(b);
                        
                        // Nếu là anh em liền kề
                        if (Math.abs(aSiblingIndex - bSiblingIndex) === 1) {
                            // Xác định node nào đứng trước, node nào đứng sau
                            const firstNode = aSiblingIndex < bSiblingIndex ? a : b;
                            const secondNode = aSiblingIndex < bSiblingIndex ? b : a;
                            
                            // Kiểm tra nếu cả hai node đều có phối ngẫu - cần khoảng cách lớn nhất
                            if (aHasSpouse && bHasSpouse) {
                                return 2.4; // Giảm từ 3.0 xuống 2.4
                            }
                            
                            // Kiểm tra nếu node đứng trước có phối ngẫu
                            if (firstNode.data.hasSpouse && firstNode.data.spouses && firstNode.data.spouses.length > 0) {
                                return 2.2; // Giảm từ 2.8 xuống 2.2
                            }
                            
                            // Nếu một trong hai node có phối ngẫu
                            if (aHasSpouse || bHasSpouse) {
                                return 1.8; // Giảm từ 2.0 xuống 1.8
                            }
                            
                            // Trường hợp cả hai node đều không có phối ngẫu
                            return 1.3; // Giảm từ 1.4 xuống 1.3
                        }
                        
                        // Nếu không phải anh em liền kề (cách nhau >1 vị trí)
                        return 1.4 + (Math.abs(aSiblingIndex - bSiblingIndex) - 1) * 0.2; // Giảm hệ số
                    } else {
                        // Nếu khác cha mẹ
                        return 1.8; // Giảm từ 2.0 xuống 1.8
                    }
                });
            
            // Tạo hierarchy từ dữ liệu
            const root = d3.hierarchy(formattedData.root);
            
            // Thiết lập mở rộng chỉ 1 cấp đầu tiên (thế hệ 1)
            root.descendants().forEach(d => {
                // Lưu tất cả các node con vào _children
                d._children = d.children;
                
                // Chỉ hiển thị children cho đời 1 (node gốc)
                if (d.depth > 0) {
                    d.children = null;
                }
            });
            
            // Cập nhật cây
            function updateTree(source) {
                // Tính toán layout mới
                const treeData = treeLayout(root);
                
                // Lấy tất cả nodes và links
                const nodes = treeData.descendants();
                const links = treeData.links();
                
                // Thiết lập vị trí y dựa trên depth
                nodes.forEach(d => {
                    d.y = d.depth * 120; // Tăng từ 100 lên 120 để tăng khoảng cách giữa các thế hệ
                });
                
                // ===== NODES =====
                // Cập nhật nodes
                const node = svg.selectAll(".node")
                    .data(nodes, d => d.data.id);
                
                // Enter new nodes
                const nodeEnter = node.enter()
                    .append("g")
                    .attr("class", d => {
                        let classes = "node";
                        if (d.data.gender === "male") classes += " male";
                        else if (d.data.gender === "female") classes += " female";
                        if (d.data.hasSpouse) classes += " couple";
                        return classes;
                    })
                    .attr("transform", d => `translate(${source.x0 || 0},${source.y0 || 0})`)
                    .on("click", (event, d) => {
                        // Ngăn sự kiện lan truyền để không mở modal khi click vào nút +/-
                        const target = event.target;
                        const isButton = target.tagName === "circle" || 
                                        (target.tagName === "text" && target.parentNode && 
                                         target.parentNode.classList.contains("node-button"));
                        
                        if (isButton) {
                            event.stopPropagation();
                            return;
                        }
                        
                        // Hiển thị chi tiết người
                        showPersonDetail(d.data.id);
                    });
                
                // Thêm hình chữ nhật cho node
                nodeEnter.append("rect")
                    .attr("width", 160)  // Giảm từ 200 xuống 160
                    .attr("height", 50)
                    .attr("x", -80)  // Điều chỉnh từ -100 xuống -80
                    .attr("y", -25)
                    .attr("rx", 5)
                    .attr("ry", 5);
                
                // Thêm ảnh đại diện sử dụng phương pháp zoom thay vì clip-path
                nodeEnter.append("foreignObject")
                    .attr("x", -88)  // Điều chỉnh vị trí
                    .attr("y", -22)  // Điều chỉnh vị trí
                    .attr("width", 40)  // Kích thước ảnh
                    .attr("height", 40)  // Kích thước ảnh
                    .html(d => {
                        return `<div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden;">
                            <img src="${d.data.img}" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>`;
                    });
                
                // Thêm tên - đặt ngang với ảnh
                nodeEnter.append("text")
                    .attr("dy", 0)
                    .attr("dx", 0)
                    .attr("text-anchor", "middle")
                    .text(d => {
                        // Cắt ngắn tên nếu quá dài
                        let name = d.data.name || '';
                        return name.length > 30 ? name.substring(0, 27) + '...' : name;
                    })
                    .style("font-size", "12px")
                    .style("font-weight", "bold");
                
                // Thêm ngày sinh - đặt dưới tên
                nodeEnter.append("text")
                    .attr("dy", 15)
                    .attr("text-anchor", "middle")
                    .text(d => d.data.birth)
                    .style("font-size", "10px");
                
                // XÓA ĐOẠN CODE LỖI Ở ĐÂY: Đã xóa đoạn code tạo spouseGroup bị sai vị trí
                        
                // Thêm nút mở rộng/thu gọn - điều chỉnh lại vị trí
                nodeEnter.append("g")
                    .attr("class", "node-button")
                    .attr("transform", "translate(-95, -20)")
                    .style("display", d => {
                        // Kiểm tra nếu node có con ẩn
                        return d._children && d._children.length > 0 ? "block" : "none";
                    })
                    .on("click", (event, d) => {
                        event.stopPropagation();
                        // Toggle trạng thái hiển thị của con
                        if (d.children) {
                            d._children = d.children;
                            d.children = null;
                        } else {
                            d.children = d._children;
                        }
                        updateTree(d);
                    });
                
                // Thêm background cho nút
                nodeEnter.select(".node-button")
                    .append("circle")
                    .attr("r", 18) // Giữ ở 18px theo yêu cầu
                    .style("fill", "#fff")
                    .style("stroke", "#0066cc")
                    .style("stroke-width", "2px");
                
                // Thêm dấu + hoặc - vào nút
                nodeEnter.select(".node-button")
                    .append("text")
                    .attr("dy", 6) // Điều chỉnh từ 8 xuống 6 để căn giữa phù hợp với kích thước mới
                    .attr("text-anchor", "middle")
                    .style("font-size", "24px") // Giảm từ 32px xuống 24px để cân đối với kích thước vòng tròn mới
                    .style("font-weight", "bold")
                    .style("pointer-events", "none") // Đảm bảo text không chặn sự kiện click
                    .style("fill", "#0066cc")
                    .text(d => d.children ? "-" : "+");
                
                // Thêm thông tin vợ/chồng nếu có
                const coupleNodes = nodeEnter.filter(d => d.data.hasSpouse && d.data.spouses && d.data.spouses.length > 0);
                
                // Thêm node vợ/chồng
                coupleNodes.each(function(d) {
                    // Bỏ đường nối vợ chồng cho từng người riêng biệt
                    d3.select(this).selectAll(".marriage-link").remove();
                    
                    // Chỉ tạo một node phối ngẫu duy nhất cho tất cả vợ/chồng
                    const spouseGroup = d3.select(this)
                        .append("g")
                        .attr("class", "spouse-node")
                        .attr("transform", `translate(${145}, 0)`);  // Điều chỉnh từ 165 xuống 145
                        
                    // Tính toán chiều cao node dựa trên số lượng phối ngẫu
                    const spouseCount = d.data.spouses.length;
                    const nodeHeight = Math.max(50, 35 + (spouseCount - 1) * 15);
                    
                    // Tạo hình chữ nhật cho node vợ/chồng
                    spouseGroup.append("rect")
                        .attr("width", 160)  // Giảm từ 200 xuống 160
                        .attr("height", nodeHeight)
                        .attr("x", -80)  // Điều chỉnh từ -100 xuống -80
                        .attr("y", -nodeHeight/2)
                        .attr("rx", 5)
                        .attr("ry", 5)
                        .attr("stroke", d.data.spouses[0].gender === "male" ? "#0066cc" : "#e91e63");
                    
                    // Không thêm đường nối vợ chồng nữa vì đã đặt sát nhau
                    
                    // Chỉ hiển thị avatar của người phối ngẫu đầu tiên
                    spouseGroup.append("foreignObject")
                        .attr("x", -70)  // Điều chỉnh từ -88 lên -70
                        .attr("y", -nodeHeight/2 + 3)
                        .attr("width", 40)
                        .attr("height", 40)
                        .html(() => {
                            return `<div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden;">
                                <img src="${d.data.spouses[0].img}" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>`;
                        });
                    
                    // Nội dung hiển thị tên tất cả các người phối ngẫu
                    let spouseNames = "";
                    
                    // Xử lý tên người phối ngẫu thứ nhất
                    let firstName = d.data.spouses[0].name;
                    if (firstName.length > 16) {  // Giảm từ 20 xuống 16
                        firstName = firstName.substring(0, 13) + '...';  // Giảm từ 17 xuống 13
                    }
                    spouseNames = firstName;
                    
                    // Thêm tên các người phối ngẫu còn lại - bỏ dấu "+"
                    if (d.data.spouses.length > 1) {
                        for (let i = 1; i < d.data.spouses.length; i++) {
                            // Cắt bớt tên nếu quá dài
                            let spouseName = d.data.spouses[i].name;
                            if (spouseName.length > 16) {  // Giảm từ 20 xuống 16
                                spouseName = spouseName.substring(0, 13) + '...';  // Giảm từ 17 xuống 13
                            }
                            spouseNames += `<tspan x="0" dy="15">${spouseName}</tspan>`;
                        }
                    }
                    
                    // Điều chỉnh vị trí bắt đầu của text tùy thuộc vào chiều cao
                    const textStartY = spouseCount > 1 ? -((spouseCount - 1) * 7) : 0;
                    
                    // Thêm tên người phối ngẫu với padding bên phải để không chồng lên avatar
                    spouseGroup.append("text")
                        .attr("dy", textStartY)
                        .attr("dx", 5)  // Giảm từ 10 xuống 5
                        .attr("text-anchor", "middle")
                        .html(spouseNames)
                        .style("font-size", "12px")
                        .style("font-weight", "bold");
                });
                
                // Transition nodes to their new position
                const nodeUpdate = nodeEnter.merge(node)
                    .transition()
                    .duration(750)
                    .attr("transform", d => `translate(${d.x},${d.y})`);
                
                // Update nút mở rộng/thu gọn sau transition
                svg.selectAll(".node").select(".node-button")
                    .style("display", d => {
                        return d._children && d._children.length > 0 ? "block" : "none";
                    })
                    .select("text")
                    .text(d => d.children ? "-" : "+");
                
                // Transition exiting nodes to parent's position
                const nodeExit = node.exit()
                    .transition()
                    .duration(750)
                    .attr("transform", d => `translate(${source.x},${source.y})`)
                    .remove();
                
                // ===== LINKS =====
                // Cập nhật links
                const link = svg.selectAll(".link")
                    .data(links, d => d.target.data.id);
                
                // Hàm tạo đường cong cho link - điều chỉnh để nối từ chân node cha đến đầu node con
                const diagonal = d3.linkVertical()
                    .x(d => d.x)
                    .y(d => {
                        // Nếu là điểm nguồn (source/cha), lấy tọa độ ở chân node cha
                        if (d === d.source) {
                            return d.y + 25; // Điều chỉnh theo chiều cao mới của node
                        }
                        // Nếu là điểm đích (target/con), lấy tọa độ ở đầu node con
                        return d.y - 25; // Điều chỉnh theo chiều cao mới của node
                    });
                
                // Enter new links
                const linkEnter = link.enter()
                    .append("path")
                    .attr("class", "link")
                    .attr("d", d => {
                        const o = {x: source.x0 || 0, y: source.y0 || 0};
                        return `M${o.x},${o.y + 25} C${o.x},${o.y + 50} ${o.x},${o.y - 10} ${o.x},${o.y - 25}`;
                    });
                
                // Transition links to their new position
                linkEnter.merge(link)
                    .transition()
                    .duration(750)
                    .attr("d", d => {
                        const sourceX = d.source.x;
                        const sourceY = d.source.y + 25; // Điều chỉnh từ 30 xuống 25 (chiều cao node giảm)
                        const targetX = d.target.x;
                        const targetY = d.target.y - 25; // Điều chỉnh từ 30 xuống 25 (chiều cao node giảm)
                        
                        // Tạo đường cong Bezier với điểm kiểm soát gần hơn để phù hợp với khoảng cách ngắn hơn
                        // Điểm kiểm soát 1: Xuống dưới từ nguồn
                        const controlX1 = sourceX;
                        const controlY1 = sourceY + 20; // Giảm từ 25 xuống 20
                        
                        // Điểm kiểm soát 2: Lên trên từ đích
                        const controlX2 = targetX;
                        const controlY2 = targetY - 20; // Giảm từ 25 xuống 20
                        
                        return `M${sourceX},${sourceY} C${controlX1},${controlY1} ${controlX2},${controlY2} ${targetX},${targetY}`;
                    });
                
                // Transition exiting links to parent's position
                link.exit()
                    .transition()
                    .duration(750)
                    .attr("d", d => {
                        const o = {x: source.x, y: source.y};
                        return `M${o.x},${o.y + 25} C${o.x},${o.y + 50} ${o.x},${o.y - 10} ${o.x},${o.y - 25}`;
                    })
                    .remove();
                
                // Lưu vị trí cũ cho transitions
                nodes.forEach(d => {
                    d.x0 = d.x;
                    d.y0 = d.y;
                });
            }
            
            // Khởi tạo vị trí ban đầu
            root.x0 = 0;
            root.y0 = 0;
            
            // Cập nhật cây lần đầu
            updateTree(root);
            
            // Tạo một đối tượng giả để tương thích với code cũ
            return {
                on: function(event, callback) {
                    if (event === 'click') {
                        // D3 đã xử lý sự kiện click trong updateTree
                        return this;
                    }
                    return this;
                },
                collapse: function(id, value) {
                    // Tìm node theo id và thu gọn
                    const findAndCollapseNode = (node) => {
                        if (node.data.id === id) {
                            if (value) {
                                node._children = node.children;
                                node.children = null;
                        } else {
                                node.children = node._children;
                        }
                            updateTree(node);
                            return true;
                    }
                        if (node.children) {
                            for (const child of node.children) {
                                if (findAndCollapseNode(child)) return true;
                }
                        }
                        return false;
                    };

                    findAndCollapseNode(root);
                    return this;
                }
            };
        }

        // API Key và Client ID cho Google Drive API
        const API_KEY = 'YOUR_API_KEY'; // Thay bằng API key thực tế của bạn
        const CLIENT_ID = 'YOUR_CLIENT_ID'; // Thay bằng Client ID thực tế của bạn
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        // Biến lưu trữ ID của người đang được hiển thị chi tiết
        let currentPersonId = null;
        
        // Hàm khởi tạo Google API Client
        function initGoogleAPI() {
            gapi.load('client:auth2', () => {
                gapi.client.init({
                    apiKey: API_KEY,
                    clientId: CLIENT_ID,
                    discoveryDocs: DISCOVERY_DOCS,
                    scope: SCOPES
                }).then(() => {
                    // API đã được khởi tạo thành công
                    console.log('Google API đã được khởi tạo');
                    
                    // Lắng nghe sự kiện đăng nhập/đăng xuất
                    gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                    
                    // Kiểm tra trạng thái đăng nhập ban đầu
                    updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                    
                }).catch(error => {
                    console.error('Lỗi khi khởi tạo Google API:', error);
                    document.getElementById('errorMessage').textContent = 'Không thể kết nối với Google API. Vui lòng thử lại sau.';
                    document.getElementById('errorMessage').style.display = 'block';
                });
            });
        }
        
        // Cập nhật trạng thái đăng nhập
        function updateSigninStatus(isSignedIn) {
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (isSignedIn) {
                // Đã đăng nhập, kích hoạt nút upload nếu có file
                if (document.getElementById('fileInput').files.length > 0) {
                    uploadBtn.disabled = false;
                }
                
                uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Tải lên Google Drive';
            } else {
                // Chưa đăng nhập, sửa nút upload để đăng nhập
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Đăng nhập với Google để tải lên';
                
                // Thay đổi hành động của nút upload thành đăng nhập
                uploadBtn.onclick = () => {
                    gapi.auth2.getAuthInstance().signIn();
                };
            }
        }
        
        // Hàm thay đổi kích thước ảnh
        function resizeImage(file, maxWidth, callback) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;
                img.onload = function() {
                    // Tính toán tỷ lệ để giữ nguyên tỷ lệ khi thay đổi kích thước
                    const width = img.width;
                    const height = img.height;
                    let newWidth = width;
                    let newHeight = height;
                    
                    if (width > maxWidth) {
                        newWidth = maxWidth;
                        newHeight = (height * maxWidth) / width;
                    }
                    
                    // Tạo canvas để vẽ ảnh với kích thước mới
                    const canvas = document.createElement('canvas');
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    
                    // Chuyển đổi canvas thành Blob
                    canvas.toBlob(callback, file.type);
                };
            };
        }
        
        // Hàm tải ảnh lên Google Drive
        function uploadImageToDrive(file) {
            const uploadProgress = document.getElementById('uploadProgress');
            const progressBarFill = document.getElementById('progressBarFill');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            const uploadBtn = document.getElementById('uploadBtn');
            
            // Hiển thị thanh tiến trình
            uploadProgress.style.display = 'block';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            uploadBtn.disabled = true;
            
            // Tạo tên file dựa trên thông tin người
            const person = familyData.find(p => p.id === currentPersonId);
            const timestamp = new Date().getTime();
            const fileName = `${person.name}_${person.id}_${timestamp}.jpg`;
            
            // Chuẩn bị metadata cho file
            const metadata = {
                name: fileName,
                mimeType: file.type,
                description: `Ảnh đại diện của ${person.name} (ID: ${person.id}) trong gia phả họ Nguyễn Bá`
            };
            
            // Tạo form data
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);
            
            // Tạo và gửi request
            const xhr = new XMLHttpRequest();
            xhr.open('POST', 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart');
            
            // Thêm token xác thực
            const token = gapi.auth.getToken();
            if (token) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + token.access_token);
            }
            
            // Xử lý sự kiện upload
            xhr.upload.onprogress = function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressBarFill.style.width = percentComplete + '%';
                }
            };
            
            xhr.onload = function() {
                if (xhr.status === 200 || xhr.status === 201) {
                    const response = JSON.parse(xhr.response);
                    console.log('File đã được tải lên:', response);
                    
                    // Cập nhật URL ảnh trong dữ liệu
                    const fileId = response.id;
                    const fileUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
                    
                    // Cập nhật dữ liệu người với URL ảnh mới
                    updatePersonPhoto(currentPersonId, fileUrl);
                    
                    // Hiển thị thông báo thành công
                    successMessage.textContent = 'Ảnh đã được tải lên thành công và cập nhật cho người này.';
                    successMessage.style.display = 'block';
                    
                    // Ẩn thanh tiến trình
                    uploadProgress.style.display = 'none';
                    uploadBtn.disabled = false;
                } else {
                    console.error('Lỗi khi tải lên:', xhr.status, xhr.statusText);
                    errorMessage.textContent = `Lỗi khi tải lên: ${xhr.statusText}`;
                    errorMessage.style.display = 'block';
                    uploadProgress.style.display = 'none';
                    uploadBtn.disabled = false;
                }
            };
            
            xhr.onerror = function() {
                console.error('Lỗi kết nối khi tải lên');
                errorMessage.textContent = 'Lỗi kết nối khi tải lên. Vui lòng kiểm tra kết nối mạng và thử lại.';
                errorMessage.style.display = 'block';
                uploadProgress.style.display = 'none';
                uploadBtn.disabled = false;
            };
            
            xhr.send(form);
        }
        
        // Hàm cập nhật URL ảnh cho người
        function updatePersonPhoto(personId, photoUrl) {
            // Cập nhật dữ liệu trong bộ nhớ
            const personIndex = familyData.findIndex(p => p.id === personId);
            if (personIndex !== -1) {
                familyData[personIndex].photo = photoUrl;
                
                // Cập nhật lại cây gia phả
                const formattedData = formatFamilyData(familyData);
                
                // Khởi tạo lại D3.js tree với dữ liệu mới
                document.getElementById('family-tree').innerHTML = '';
                familyChart = initializeD3Tree(formattedData);
                
                // Cập nhật ảnh trong modal chi tiết
                const personImage = document.querySelector('#person-detail-content .node-image');
                if (personImage) {
                    personImage.src = photoUrl;
                }
                
                // Gửi API cập nhật dữ liệu nếu có
                try {
                    fetch(`/api/family/${personId}/photo`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ photo: photoUrl })
                    })
                    .then(response => {
                        if (!response.ok) {
                            console.warn('Lưu ý: Không thể cập nhật dữ liệu trên máy chủ.');
                        }
                    })
                    .catch(error => {
                        console.warn('Lưu ý: Lỗi khi gửi cập nhật đến máy chủ:', error);
                    });
                } catch (error) {
                    console.warn('Lưu ý: Không thể gửi cập nhật đến máy chủ:', error);
                }
            }
        }
        
        // Hàm thiết lập sự kiện cho phần upload ảnh
        function setupImageUploadEvents() {
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const fileName = document.getElementById('fileName');
            const imagePreview = document.getElementById('imagePreview');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            
            // Sự kiện khi chọn file
            fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    
                    // Kiểm tra loại file
                    if (!file.type.match('image.*')) {
                        document.getElementById('errorMessage').textContent = 'Vui lòng chọn file ảnh hợp lệ.';
                        document.getElementById('errorMessage').style.display = 'block';
                        this.value = '';
                        fileName.textContent = '';
                        imagePreviewContainer.style.display = 'none';
                        uploadBtn.disabled = true;
                        return;
                    }
                    
                    // Hiển thị tên file
                    fileName.textContent = file.name;
                    
                    // Hiển thị preview ảnh
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        imagePreviewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                    
                    // Kiểm tra trạng thái đăng nhập Google để kích hoạt nút upload
                    if (gapi.auth2 && gapi.auth2.getAuthInstance() && gapi.auth2.getAuthInstance().isSignedIn.get()) {
                        uploadBtn.disabled = false;
                        uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Tải lên Google Drive';
                        
                        // Thiết lập sự kiện click để upload
                        uploadBtn.onclick = function() {
                            // Thay đổi kích thước ảnh trước khi upload
                            resizeImage(file, 640, function(resizedFile) {
                                uploadImageToDrive(resizedFile);
                            });
                        };
                    } else {
                        // Chưa đăng nhập Google
                        uploadBtn.disabled = false;
                        uploadBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Đăng nhập với Google để tải lên';
                        
                        // Thay đổi hành động của nút upload thành đăng nhập
                        uploadBtn.onclick = function() {
                            gapi.auth2.getAuthInstance().signIn();
                        };
                    }
                } else {
                    fileName.textContent = '';
                    imagePreviewContainer.style.display = 'none';
                    uploadBtn.disabled = true;
                }
            });
        }

        // Hiển thị chi tiết một người
        function showPersonDetail(personId) {
            const person = familyData.find(p => p.id === personId);

            if (!person) {
                return;
            }
            
            // Lưu ID người đang xem
            currentPersonId = personId;

            const modal = document.getElementById('person-detail-modal');
            const contentContainer = document.getElementById('person-detail-content');

            // Tính tuổi hoặc năm sống
            let lifespan = '';
            let detailedBirthInfo = 'Không có thông tin';
            
            if (person.birthDate) {
                const birthDate = new Date(person.birthDate);
                const birthDay = birthDate.getDate();
                const birthMonth = birthDate.getMonth() + 1;
                const birthYear = birthDate.getFullYear();
                
                // Tính tuổi
                const currentYear = new Date().getFullYear();
                const age = person.deathDate ? 
                    (new Date(person.deathDate).getFullYear() - birthYear) : 
                    (currentYear - birthYear);
                
                // Format thông tin chi tiết ngày sinh
                detailedBirthInfo = `${birthDay}/${birthMonth}/${birthYear} (${age} tuổi)`;
                
                // Format lifespan đơn giản như trước
                if (person.deathDate) {
                    const deathYear = new Date(person.deathDate).getFullYear();
                    lifespan = `${birthYear} - ${deathYear}`;
                } else {
                    lifespan = `Sinh năm ${birthYear}`;
                }
            }

            // Ảnh đại diện theo giới tính
            let photoUrl = person.photo;
            if (!photoUrl) {
                if (person.gender === 'male') {
                    photoUrl = 'https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_1280.png';
                } else {
                    photoUrl = 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png';
                }
            }

            // Tìm thông tin cha mẹ
            let parentsHTML = '<p>Không có thông tin</p>';
            if (person.parents && person.parents.length > 0) {
                parentsHTML = '<div class="relation-list">';
                person.parents.forEach(parentId => {
                    const parentData = familyData.find(p => p.id === parentId);
                    if (parentData) {
                        parentsHTML += `
                            <div class="relation-item">
                                ${parentData.name} (${parentData.gender === 'male' ? 'Cha' : 'Mẹ'})
                            </div>
                        `;
                    }
                });
                parentsHTML += '</div>';
            }

            // Tìm thông tin vợ/chồng
            let spousesHTML = '<p>Không có thông tin</p>';
            if (person.spouses && person.spouses.length > 0) {
                spousesHTML = '<div class="relation-list">';
                person.spouses.forEach(spouseId => {
                    const spouseData = familyData.find(p => p.id === spouseId);
                    if (spouseData) {
                        spousesHTML += `
                            <div class="relation-item">
                                ${spouseData.name} (${spouseData.gender === 'male' ? 'Chồng' : 'Vợ'})
                            </div>
                        `;
                    }
                });
                spousesHTML += '</div>';
            }

            // Tìm thông tin con cái
            let childrenHTML = '<p>Không có thông tin</p>';
            if (person.children && person.children.length > 0) {
                childrenHTML = '<div class="relation-list">';
                person.children.forEach(childId => {
                    const childData = familyData.find(p => p.id === childId);
                    if (childData) {
                        childrenHTML += `
                            <div class="relation-item">
                                ${childData.name} (${childData.gender === 'male' ? 'Con trai' : 'Con gái'})
                            </div>
                        `;
                    }
                });
                childrenHTML += '</div>';
            }

            // Tạo nội dung chi tiết người
            contentContainer.innerHTML = `
                <div class="person-detail-header">
                    <img src="${photoUrl}" alt="${person.name}" class="node-image">
                    <div class="person-detail-info">
                        <h2 class="person-detail-name">${person.name}</h2>
                        <p class="person-detail-dates">${lifespan}</p>
                        <p>Thế hệ: ${person.generation}</p>
                        <p>Giới tính: ${person.gender === 'male' ? 'Nam' : 'Nữ'}</p>
                    </div>
                </div>
                
                <div class="person-detail-section" style="background-color: #f5f8ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h3 style="margin-top: 0; color: #0066cc;">Thông tin ngày sinh</h3>
                    <p style="font-size: 16px; margin-bottom: 8px;">
                        <i class="fas fa-birthday-cake" style="color: #0066cc; margin-right: 8px;"></i>
                        <strong>${detailedBirthInfo}</strong>
                    </p>
                    <p style="font-size: 14px; color: #666;">
                        ${person.deathDate ? 
                          `<i class="fas fa-cross" style="margin-right: 8px;"></i>Ngày mất: ${new Date(person.deathDate).getDate()}/${new Date(person.deathDate).getMonth() + 1}/${new Date(person.deathDate).getFullYear()}` : 
                          ''}
                    </p>
                </div>
                
                <div class="person-detail-section">
                    <h3>Cha mẹ</h3>
                    ${parentsHTML}
                </div>
                
                <div class="person-detail-section">
                    <h3>Vợ/Chồng</h3>
                    ${spousesHTML}
                </div>
                
                <div class="person-detail-section">
                    <h3>Con cái</h3>
                    ${childrenHTML}
                </div>
            `;
            
            // Hiển thị modal
            modal.style.display = 'block';
        }

        // Thiết lập sự kiện cho modal
        function setupModalEvents() {
            const modal = document.getElementById('person-detail-modal');
            const closeBtn = document.getElementById('close-modal');

            // Đóng modal khi nhấp vào nút đóng
            closeBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });

            // Đóng modal khi nhấp vào bên ngoài
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Sự kiện khi tài liệu đã tải xong
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Hiển thị loading indicator
                document.getElementById('loading-indicator').style.display = 'block';

                // Lấy dữ liệu gia phả
                familyData = await getFamilyData();

                // Kiểm tra xem có dữ liệu không
                if (familyData.length === 0) {
                    document.getElementById('loading-indicator').style.display = 'none';
                    document.getElementById('empty-state').style.display = 'block';
                    return;
                }

                // Chuyển đổi dữ liệu cho D3.js
                const formattedData = formatFamilyData(familyData);
                
                // Khởi tạo D3.js tree
                document.getElementById('family-tree-container').style.display = 'block';
                familyChart = initializeD3Tree(formattedData);

                // Ẩn loading indicator
                document.getElementById('loading-indicator').style.display = 'none';

                // Thiết lập sự kiện cho modal
                setupModalEvents();
                
                // Thiết lập sự kiện cho tab view
                setupViewTabs();
                
                // Khởi tạo danh sách phân trang
                initializeList();
            } catch (error) {
                console.error('Lỗi khi hiển thị cây gia phả:', error);
                document.getElementById('loading-indicator').style.display = 'none';

                const errorMessage = document.createElement('p');
                errorMessage.style.textAlign = 'center';
                errorMessage.style.padding = '40px 0';
                errorMessage.style.color = '#e74c3c';
                errorMessage.textContent = `Lỗi khi tải dữ liệu gia phả: ${error.message}`;
                document.getElementById('family-tree-container').appendChild(errorMessage);
                document.getElementById('family-tree-container').style.display = 'block';
            }
        });
        
        // Thiết lập sự kiện cho tab view
        function setupViewTabs() {
            const treeViewBtn = document.getElementById('tree-view-btn');
            const listViewBtn = document.getElementById('list-view-btn');
            const treeContainer = document.getElementById('family-tree-container');
            const listContainer = document.getElementById('family-list-container');
            
            treeViewBtn.addEventListener('click', function() {
                treeViewBtn.classList.add('active');
                listViewBtn.classList.remove('active');
                treeContainer.style.display = 'block';
                listContainer.style.display = 'none';
            });
            
            listViewBtn.addEventListener('click', function() {
                listViewBtn.classList.add('active');
                treeViewBtn.classList.remove('active');
                listContainer.style.display = 'block';
                treeContainer.style.display = 'none';
            });
        }
        
        // Khởi tạo danh sách phân trang
        function initializeList() {
            // Khởi tạo filteredData
            filteredData = [...familyData];
            
            // Sắp xếp dữ liệu
            sortData();
            
            // Hiển thị trang đầu tiên
            renderPage(1);
            
            // Thiết lập sự kiện cho phân trang
            setupPaginationEvents();
            
            // Thiết lập sự kiện cho sắp xếp
            setupSortEvents();
            
            // Thiết lập sự kiện cho tìm kiếm
            setupSearchEvents();
        }
        
        // Sắp xếp dữ liệu theo trường và thứ tự chỉ định
        function sortData() {
            filteredData.sort((a, b) => {
                // Xử lý trường hợp giá trị null hoặc undefined
                if (a[currentSortField] === undefined || a[currentSortField] === null) return 1;
                if (b[currentSortField] === undefined || b[currentSortField] === null) return -1;
                
                let valueA, valueB;
                
                // Xử lý đặc biệt cho các trường ngày tháng
                if (currentSortField === 'birthDate' || currentSortField === 'deathDate') {
                    valueA = new Date(a[currentSortField] || '1900-01-01').getTime();
                    valueB = new Date(b[currentSortField] || '1900-01-01').getTime();
                } else {
                    valueA = a[currentSortField];
                    valueB = b[currentSortField];
                    
                    // Chuyển đổi sang kiểu số nếu có thể
                    if (!isNaN(valueA)) valueA = Number(valueA);
                    if (!isNaN(valueB)) valueB = Number(valueB);
                    
                    // Chuyển đổi sang chữ thường nếu là chuỗi
                    if (typeof valueA === 'string') valueA = valueA.toLowerCase();
                    if (typeof valueB === 'string') valueB = valueB.toLowerCase();
                }
                
                // Sắp xếp tăng dần hoặc giảm dần
                if (currentSortOrder === 'asc') {
                    return valueA > valueB ? 1 : -1;
                } else {
                    return valueA < valueB ? 1 : -1;
                }
            });
        }
        
        // Lọc dữ liệu theo từ khóa tìm kiếm
        function filterData() {
            if (!currentSearchTerm.trim()) {
                filteredData = [...familyData];
            } else {
                const searchTermLower = currentSearchTerm.toLowerCase();
                filteredData = familyData.filter(person => {
                    return (
                        (person.name && person.name.toLowerCase().includes(searchTermLower)) ||
                        (person.id && person.id.toLowerCase().includes(searchTermLower)) ||
                        (person.generation && person.generation.toString().includes(searchTermLower))
                    );
                });
            }
            
            // Sắp xếp lại dữ liệu đã lọc
            sortData();
            
            // Hiển thị lại trang đầu tiên
            currentPage = 1;
            renderPage(currentPage);
            updatePaginationControls();
        }
        
        // Hiển thị trang chỉ định
        function renderPage(page) {
            const listContainer = document.getElementById('family-list');
            
            // Tính chỉ số bắt đầu và kết thúc cho trang hiện tại
            const startIndex = (page - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, filteredData.length);
            
            // Lấy dữ liệu cho trang hiện tại
            const pageData = filteredData.slice(startIndex, endIndex);
            
            // Xóa nội dung cũ
            listContainer.innerHTML = '';
            
            // Tạo card cho mỗi người
            pageData.forEach(person => {
                // Tạo HTML cho card
                const cardElement = document.createElement('div');
                cardElement.className = `family-card ${person.gender}`;
                cardElement.dataset.id = person.id;
                
                // Tính ngày tháng hiển thị
                let lifespan = '';
                if (person.birthDate) {
                    const birthYear = new Date(person.birthDate).getFullYear();
                    if (person.deathDate) {
                        const deathYear = new Date(person.deathDate).getFullYear();
                        lifespan = `${birthYear} - ${deathYear}`;
                    } else {
                        lifespan = `Sinh năm ${birthYear}`;
                    }
                }
                
                // Lấy avatar
                let photoUrl = person.photo;
                if (!photoUrl) {
                    if (person.gender === 'male') {
                        photoUrl = 'https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_1280.png';
                    } else {
                        photoUrl = 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png';
                    }
                }
                
                // Đếm số lượng quan hệ
                const spouseCount = person.spouses ? person.spouses.length : 0;
                const childCount = person.children ? person.children.length : 0;
                
                // Tạo nội dung HTML cho card
                cardElement.innerHTML = `
                    <span class="generation-badge">Thế hệ ${person.generation}</span>
                    <div class="family-card-content">
                        <div class="family-card-header">
                            <img src="${photoUrl}" alt="${person.name}" class="family-card-avatar">
                            <div class="family-card-info">
                                <h3>${person.name}</h3>
                                <p>${lifespan}</p>
                                <p>${person.gender === 'male' ? 'Nam' : 'Nữ'}</p>
                            </div>
                        </div>
                        <div class="family-card-relations">
                            <span class="relation-count"><i class="fas fa-user-friends"></i> ${spouseCount} vợ/chồng</span>
                            <span class="relation-count"><i class="fas fa-child"></i> ${childCount} con</span>
                        </div>
                    </div>
                `;
                
                // Thêm sự kiện click cho card
                cardElement.addEventListener('click', function() {
                    showPersonDetail(this.dataset.id);
                });
                
                // Thêm card vào container
                listContainer.appendChild(cardElement);
            });
            
            // Cập nhật trang hiện tại
            currentPage = page;
            document.getElementById('current-page').textContent = page;
            
            // Cập nhật tổng số trang
            const totalPages = Math.ceil(filteredData.length / ITEMS_PER_PAGE);
            document.getElementById('total-pages').textContent = totalPages;
            
            // Cập nhật trạng thái nút phân trang
            updatePaginationControls();
        }
        
        // Cập nhật trạng thái của các nút phân trang
        function updatePaginationControls() {
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            const totalPages = Math.ceil(filteredData.length / ITEMS_PER_PAGE);
            
            // Cập nhật nút trang trước
            if (currentPage <= 1) {
                prevPageBtn.disabled = true;
            } else {
                prevPageBtn.disabled = false;
            }
            
            // Cập nhật nút trang sau
            if (currentPage >= totalPages) {
                nextPageBtn.disabled = true;
            } else {
                nextPageBtn.disabled = false;
            }
        }
        
        // Thiết lập sự kiện cho phân trang
        function setupPaginationEvents() {
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            
            prevPageBtn.addEventListener('click', function() {
                if (currentPage > 1) {
                    renderPage(currentPage - 1);
                }
            });
            
            nextPageBtn.addEventListener('click', function() {
                const totalPages = Math.ceil(filteredData.length / ITEMS_PER_PAGE);
                if (currentPage < totalPages) {
                    renderPage(currentPage + 1);
                }
            });
        }
        
        // Thiết lập sự kiện cho sắp xếp
        function setupSortEvents() {
            const sortFieldSelect = document.getElementById('sort-field');
            const sortOrderSelect = document.getElementById('sort-order');
            
            sortFieldSelect.addEventListener('change', function() {
                currentSortField = this.value;
                sortData();
                renderPage(1);
            });
            
            sortOrderSelect.addEventListener('change', function() {
                currentSortOrder = this.value;
                sortData();
                renderPage(1);
            });
        }
        
        // Thiết lập sự kiện cho tìm kiếm
        function setupSearchEvents() {
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            
            searchBtn.addEventListener('click', function() {
                currentSearchTerm = searchInput.value;
                filterData();
            });
            
            searchInput.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    currentSearchTerm = searchInput.value;
                    filterData();
                }
            });
        }
    </script>
</body>
</html>