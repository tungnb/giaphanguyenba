<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
    <title>Gia phả dòng họ Nguyễn Bá - xã Hoàng Sơn, huyện Nông Cống, tỉnh Thanh Hóa</title>
    <link rel="stylesheet" href="family-tree.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Thư viện OrgChart.js -->
    <script src="js/OrgChart.js"></script>

    <style>
        #family-tree-container {
            width: 100%;
            height: 700px;
            overflow: hidden;
            position: relative;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        
        /* CSS cho Node */
        .family-node {
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            background-color: white;
            transition: all 0.3s ease;
        }
        
        .family-node.male {
            border-left: 5px solid #0066cc;
        }
        
        .family-node.female {
            border-left: 5px solid #e91e63;
        }
        
        .node-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 8px;
            border: 3px solid #f0f5ff;
        }
        
        /* Tùy chỉnh cho modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }
        
        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 10px;
        }
        
        .close-modal:hover {
            color: black;
        }
        
        .loading-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
        }
        
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tùy chỉnh giao diện OrgChart */
        [data-boc-name] {
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }
        
        [data-boc-birth] {
            font-size: 12px;
            color: #666;
        }
        
        .relation-list {
            margin: 10px 0;
        }
        
        .relation-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .view-details-btn {
            display: inline-block;
            margin-top: 5px;
            font-size: 12px;
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
        }
        
        /* Tùy chỉnh đường kết nối vợ chồng */
        [data-boc-layout-path-line-marriage] {
            stroke: #FF9999;
            stroke-width: 2px;
            stroke-dasharray: 4;
        }
        
        /* Ẩn node kết nối giữa vợ chồng */
        [data-boc-tags~=partner-connection] {
            opacity: 0;
        }
        
        /* Tăng khoảng cách giữa vợ chồng */
        .partner-node {
            margin: 0 15px;
        }

        /* Thêm CSS cho single nodes */
        [data-boc-tags~=male] rect {
            stroke: #0066cc !important;
            stroke-width: 3px !important;
        }

        [data-boc-tags~=female] rect {
            stroke: #e91e63 !important;
            stroke-width: 3px !important;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="navigation-menu">
                    <a href="index.html" class="nav-item">Trang chủ</a>
                    <a href="family-tree.html" class="nav-item active">Gia phả</a>
                    <a href="all-posts.html" class="nav-item">Tất cả bài viết</a>
                </div>

                <div class="author-info">
                    <div class="avatar-container">
                        <img src="profile3.jpg" alt="Avatar" class="avatar-img">
                    </div>
                    <div class="author-text-content">
                        <p class="author-title">Chào mừng bạn đến với website gia phả họ Nguyễn Bá</p>

                        <div class="social-links">
                            <a href="https://www.facebook.com/tungnb/" class="social-btn social-tooltip" title="Facebook">
                                <i class="fab fa-facebook-f"></i>
                                <span class="tooltip-text">Facebook</span>
                            </a>

                            <a href="mailto:tungnguyen@mayhoangtung.com" class="social-btn social-tooltip" title="Email">
                                <i class="fas fa-envelope"></i>
                                <span class="tooltip-text">tungnguyen@mayhoangtung.com</span>
                            </a>

                            <a href="tel:0983887485" class="social-btn social-tooltip" title="Điện thoại">
                                <i class="fas fa-phone"></i>
                                <span class="tooltip-text">0983887485</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <section class="content">
        <div class="container">
            <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Quay lại trang chủ</a>

            <div id="loading-indicator" class="loading-indicator">
                <div class="loading-spinner"></div>
                <p>Đang tải dữ liệu gia phả...</p>
            </div>

            <div id="family-tree-container" class="family-tree-container" style="display: none">
                <div id="family-tree" class="chart"></div>
            </div>

            <div id="empty-state" class="empty-state" style="display: none">
                <i class="fas fa-users-slash"></i>
                <h3>Chưa có dữ liệu gia phả</h3>
                <p>Dữ liệu gia phả đang được cập nhật. Vui lòng quay lại sau.</p>
            </div>
        </div>
    </section>

    <div id="person-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="close-modal">&times;</span>
            <div id="person-detail-content">
                <!-- Chi tiết người sẽ được thêm vào đây -->
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <p class="copyright">Tạo vào © 2025 Nguyễn Bá Tùng</p>
            </div>
        </div>
    </footer>

    <script>
        // Thiết lập cấu trúc dữ liệu cho gia phả
        let familyData = [];
        let familyChart = null;

        // Thêm polyfill cho phương thức addPartnerAndParentNodes nếu nó không tồn tại trong OrgChart
        if (OrgChart && !OrgChart.prototype.addPartnerAndParentNodes) {
            OrgChart.prototype.addPartnerAndParentNodes = function(nodeId, childrenIds, partnerData) {
                console.log("Polyfill cho addPartnerAndParentNodes được gọi");
                // Đây chỉ là một hàm giả để tránh lỗi
                // Chúng ta không cần thực hiện gì cả vì việc này đã được xử lý trong 
                // hàm convertToOrgChartFormat của chúng ta
                return;
            };
        }

        // Lấy dữ liệu gia phả từ API hoặc dữ liệu mẫu
        async function getFamilyData() {
            try {
                console.log("Đang gọi API để lấy dữ liệu gia phả...");
                
                // Thêm timeout cho API call để tránh chờ quá lâu
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 giây timeout
                
                try {
                    const response = await fetch('/api/family', {
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`Lỗi khi lấy dữ liệu: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log(`Đã nhận ${data.length} người từ API`);
                    return data;
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    
                    // Nếu lỗi là do timeout hoặc network, hiển thị thông báo rõ ràng hơn
                    if (fetchError.name === 'AbortError') {
                        console.warn('API timeout sau 10 giây. Sử dụng dữ liệu mẫu.');
                        throw new Error('Kết nối API quá chậm. Đang sử dụng dữ liệu mẫu.');
                    } else {
                        console.warn('Lỗi khi gọi API:', fetchError.message);
                        throw fetchError;
                    }
                }
            } catch (error) {
                console.warn('Sử dụng dữ liệu mẫu do lỗi:', error.message);

                // Trả về dữ liệu mẫu đã có
                return [
                    {
                        id: '1',
                        name: 'Nguyễn Bá Cụ',
                        gender: 'male',
                        generation: 1,
                        birthDate: '1900-01-01',
                        deathDate: '1970-01-01',
                        spouses: ['100'],
                        children: ['2', '3', '4']
                    },
                    {
                        id: '100',
                        name: 'Nguyễn Thị Vợ Cụ',
                        gender: 'female',
                        generation: 1,
                        birthDate: '1905-01-01',
                        deathDate: '1975-01-01',
                        spouses: ['1'],
                        children: ['2', '3', '4']
                    },
                    {
                        id: '2',
                        name: 'Nguyễn Bá Trưởng',
                        gender: 'male',
                        generation: 2,
                        birthDate: '1930-01-01',
                        parents: ['1', '100'],
                        spouses: ['101'],
                        children: ['5', '6']
                    },
                    {
                        id: '101',
                        name: 'Nguyễn Thị Vợ Trưởng',
                        gender: 'female',
                        generation: 2,
                        birthDate: '1935-01-01',
                        spouses: ['2'],
                        children: ['5', '6']
                    },
                    {
                        id: '3',
                        name: 'Nguyễn Bá Thứ',
                        gender: 'male',
                        generation: 2,
                        birthDate: '1935-01-01',
                        parents: ['1', '100'],
                        spouses: ['102'],
                        children: ['7']
                    },
                    {
                        id: '102',
                        name: 'Nguyễn Thị Vợ Thứ',
                        gender: 'female',
                        generation: 2,
                        birthDate: '1940-01-01',
                        spouses: ['3'],
                        children: ['7']
                    },
                    {
                        id: '4',
                        name: 'Nguyễn Bá Út',
                        gender: 'male',
                        generation: 2,
                        birthDate: '1940-01-01',
                        parents: ['1', '100'],
                        spouses: ['103'],
                        children: ['8', '9']
                    },
                    {
                        id: '103',
                        name: 'Nguyễn Thị Vợ Út',
                        gender: 'female',
                        generation: 2,
                        birthDate: '1945-01-01',
                        spouses: ['4'],
                        children: ['8', '9']
                    },
                    {
                        id: '5',
                        name: 'Nguyễn Bá A',
                        gender: 'male',
                        generation: 3,
                        birthDate: '1960-01-01',
                        parents: ['2', '101']
                    },
                    {
                        id: '6',
                        name: 'Nguyễn Thị B',
                        gender: 'female',
                        generation: 3,
                        birthDate: '1965-01-01',
                        parents: ['2', '101']
                    },
                    {
                        id: '7',
                        name: 'Nguyễn Bá C',
                        gender: 'male',
                        generation: 3,
                        birthDate: '1965-01-01',
                        parents: ['3', '102']
                    },
                    {
                        id: '8',
                        name: 'Nguyễn Bá D',
                        gender: 'male',
                        generation: 3,
                        birthDate: '1970-01-01',
                        parents: ['4', '103']
                    },
                    {
                        id: '9',
                        name: 'Nguyễn Thị E',
                        gender: 'female',
                        generation: 3,
                        birthDate: '1975-01-01',
                        parents: ['4', '103']
                    }
                ];
            }
        }

        // Chuyển đổi cấu trúc dữ liệu cho OrgChart.js
        function convertToOrgChartFormat(familyDataArray) {
            const nodes = [];
            const processedIds = new Set(); // Theo dõi các ID đã xử lý
            const coupleNodes = new Map(); // Lưu trữ các node vợ chồng để cập nhật thông tin

            // Bước 1: Tạo node cho mỗi người (chưa có vợ/chồng)
            familyDataArray.forEach(person => {
                // Nếu đã xử lý ID này (đã thêm vào node khác), bỏ qua
                if (processedIds.has(person.id)) return;

                // Ảnh đại diện theo giới tính
                let photoUrl = person.photo;
                if (!photoUrl) {
                    if (person.gender === 'male') {
                        photoUrl = 'https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_1280.png';
                    } else {
                        photoUrl = 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png';
                    }
                }

                // Tạo chuỗi hiển thị ngày sinh, ngày mất
                let lifespan = '';
                if (person.birthDate) {
                    const birthYear = new Date(person.birthDate).getFullYear();
                    if (person.deathDate) {
                        const deathYear = new Date(person.deathDate).getFullYear();
                        lifespan = `${birthYear} - ${deathYear}`;
                    } else {
                        lifespan = `Sinh năm ${birthYear}`;
                    }
                }

                // Kiểm tra xem người này có vợ/chồng không
                if (person.spouses && person.spouses.length > 0) {
                    // Đối với mỗi vợ/chồng, tạo một node chung
                    person.spouses.forEach(spouseId => {
                        const spouse = familyDataArray.find(p => p.id === spouseId);
                        if (!spouse) return;

                        // Tạo ID cho cặp vợ chồng
                        const coupleId = [person.id, spouse.id].sort().join('_');
                        
                        // Ảnh của vợ/chồng
                        let spousePhotoUrl = spouse.photo;
                        if (!spousePhotoUrl) {
                            if (spouse.gender === 'male') {
                                spousePhotoUrl = 'https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_1280.png';
                            } else {
                                spousePhotoUrl = 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png';
                            }
                        }

                        // Lifespan của vợ/chồng
                        let spouseLifespan = '';
                        if (spouse.birthDate) {
                            const birthYear = new Date(spouse.birthDate).getFullYear();
                            if (spouse.deathDate) {
                                const deathYear = new Date(spouse.deathDate).getFullYear();
                                spouseLifespan = `${birthYear} - ${deathYear}`;
                            } else {
                                spouseLifespan = `Sinh năm ${birthYear}`;
                            }
                        }

                        // Tạo node chung cho cặp vợ chồng
                        const coupleNode = {
                            id: coupleId,
                            personId: person.id,
                            name: person.name,
                            img: photoUrl,
                            birth: lifespan,
                            personGender: person.gender,
                            spouseId: spouse.id,
                            spouseName: spouse.name,
                            spouseImg: spousePhotoUrl,
                            spouseBirth: spouseLifespan,
                            spouseGender: spouse.gender,
                            generation: person.generation,
                            tags: ['couple'],
                            children: [...(person.children || []), ...(spouse.children || [])]
                        };

                        // Thêm node vợ chồng vào mảng
                        nodes.push(coupleNode);
                        coupleNodes.set(coupleId, coupleNode);
                        
                        // Đánh dấu cả hai đã được xử lý
                        processedIds.add(person.id);
                        processedIds.add(spouse.id);
                    });
                }
                // Nếu không có vợ/chồng, tạo node bình thường
                else if (!processedIds.has(person.id)) {
                    const node = {
                        id: person.id,
                        name: person.name,
                        img: photoUrl,
                        birth: lifespan,
                        gender: person.gender,
                        generation: person.generation,
                        tags: [person.gender],
                        // Thêm một số thuộc tính để thống nhất hiển thị với couple nodes
                        personId: person.id,
                        personGender: person.gender
                    };
                    nodes.push(node);
                }
            });

            // Bước 2: Thiết lập quan hệ cha mẹ - con
            familyDataArray.forEach(person => {
                if (!person.parents || person.parents.length === 0) return;
                
                // Tìm node tương ứng của người này
                let personNode = nodes.find(n => n.id === person.id);
                
                // Nếu không tìm thấy node riêng, tìm node vợ chồng chứa người này
                if (!personNode) {
                    personNode = nodes.find(n => 
                        (n.personId === person.id) || (n.spouseId === person.id)
                    );
                }
                
                if (!personNode) return;

                // Nếu có cả cha và mẹ
                if (person.parents.length >= 2) {
                    const parentIds = person.parents.sort();
                    const coupleId = parentIds.join('_');
                    
                    // Tìm node cha mẹ
                    const parentNode = nodes.find(n => n.id === coupleId);
                    
                    if (parentNode) {
                        personNode.pid = coupleId;
                    } else {
                        // Nếu không tìm thấy node chung, sử dụng cha làm pid
                        personNode.pid = person.parents[0];
                    }
                } else if (person.parents.length === 1) {
                    // Nếu chỉ có một người làm cha/mẹ
                    personNode.pid = person.parents[0];
                }
            });

            return { nodes };
        }

        // Hàm khởi tạo OrgChart
        function initializeOrgChart(formattedData) {
            // Tạo template tùy chỉnh cho node single (người không có vợ/chồng)
            OrgChart.templates.single = Object.assign({}, OrgChart.templates.olivia);
            OrgChart.templates.single.size = [280, 120];
            OrgChart.templates.single.node = 
                '<rect x="0" y="0" width="280" height="120" rx="5" ry="5" fill="#ffffff" stroke-width="1" stroke="#E4E4E4"></rect>';
            OrgChart.templates.single.nodeMenuButton = 
                '<g style="cursor:pointer;" transform="matrix(1,0,0,1,255,15)" control-node-menu-id="{id}">' +
                '<rect x="-4" y="-4" fill="#000000" fill-opacity="0" width="30" height="30"></rect>' +
                '<circle cx="0" cy="0" r="3" fill="#757575"></circle>' +
                '<circle cx="10" cy="0" r="3" fill="#757575"></circle>' +
                '<circle cx="20" cy="0" r="3" fill="#757575"></circle>' +
                '</g>';
            OrgChart.templates.single.field_0 = 
                '<text style="font-size:14px;" fill="#2D2D2D" x="140" y="30" text-anchor="middle">{val}</text>';
            OrgChart.templates.single.field_1 = 
                '<text style="font-size:12px;" fill="#5B5B5B" x="140" y="50" text-anchor="middle">{val}</text>';
            OrgChart.templates.single.img_0 = 
                '<clipPath id="personClip_{id}"><circle cx="140" cy="80" r="25"></circle></clipPath>' +
                '<image preserveAspectRatio="xMidYMid slice" clip-path="url(#personClip_{id})" xlink:href="{val}" x="115" y="55" width="50" height="50"></image>';

            // Tùy chỉnh template cho node nam
            OrgChart.templates.single_male = Object.assign({}, OrgChart.templates.single);
            OrgChart.templates.single_male.node = 
                '<rect x="0" y="0" width="280" height="120" rx="5" ry="5" fill="#ffffff" stroke-width="3" stroke="#0066cc"></rect>';

            // Tùy chỉnh template cho node nữ
            OrgChart.templates.single_female = Object.assign({}, OrgChart.templates.single);
            OrgChart.templates.single_female.node = 
                '<rect x="0" y="0" width="280" height="120" rx="5" ry="5" fill="#ffffff" stroke-width="3" stroke="#e91e63"></rect>';

            // Tạo template tùy chỉnh cho node vợ chồng
            OrgChart.templates.couple = Object.assign({}, OrgChart.templates.olivia);
            OrgChart.templates.couple.size = [280, 120];
            OrgChart.templates.couple.node = 
                '<rect x="0" y="0" width="280" height="120" rx="5" ry="5" fill="#ffffff" stroke-width="3" stroke="#E4E4E4"></rect>' +
                '<line x1="140" y1="0" x2="140" y2="120" stroke="#E4E4E4" stroke-width="1"></line>';
            OrgChart.templates.couple.nodeMenuButton = 
                '<g style="cursor:pointer;" transform="matrix(1,0,0,1,255,15)" control-node-menu-id="{id}">' +
                '<rect x="-4" y="-4" fill="#000000" fill-opacity="0" width="30" height="30"></rect>' +
                '<circle cx="0" cy="0" r="3" fill="#757575"></circle>' +
                '<circle cx="10" cy="0" r="3" fill="#757575"></circle>' +
                '<circle cx="20" cy="0" r="3" fill="#757575"></circle>' +
                '</g>';
            OrgChart.templates.couple.field_0 = 
                '<text style="font-size:14px;" fill="#2D2D2D" x="70" y="30" text-anchor="middle">{val}</text>';
            OrgChart.templates.couple.field_1 = 
                '<text style="font-size:12px;" fill="#5B5B5B" x="70" y="50" text-anchor="middle">{val}</text>';
            OrgChart.templates.couple.field_2 = 
                '<text style="font-size:14px;" fill="#2D2D2D" x="210" y="30" text-anchor="middle">{val}</text>';
            OrgChart.templates.couple.field_3 = 
                '<text style="font-size:12px;" fill="#5B5B5B" x="210" y="50" text-anchor="middle">{val}</text>';
            OrgChart.templates.couple.img_0 = 
                '<clipPath id="personClip_{id}"><circle cx="70" cy="80" r="25"></circle></clipPath>' +
                '<image preserveAspectRatio="xMidYMid slice" clip-path="url(#personClip_{id})" xlink:href="{val}" x="45" y="55" width="50" height="50"></image>';
            OrgChart.templates.couple.img_1 = 
                '<clipPath id="spouseClip_{id}"><circle cx="210" cy="80" r="25"></circle></clipPath>' +
                '<image preserveAspectRatio="xMidYMid slice" clip-path="url(#spouseClip_{id})" xlink:href="{val}" x="185" y="55" width="50" height="50"></image>';

            // Tùy chỉnh template cho node vợ chồng khi người con trong gia phả là nam
            OrgChart.templates.couple_male = {};
            OrgChart.templates.couple_male.size = [280, 120];
            OrgChart.templates.couple_male.node = 
                '<rect x="0" y="0" width="280" height="120" rx="5" ry="5" fill="#ffffff" stroke-width="3" stroke="#0066cc"></rect>' +
                '<line x1="140" y1="0" x2="140" y2="120" stroke="#E4E4E4" stroke-width="1"></line>';
            OrgChart.templates.couple_male.nodeMenuButton = 
                '<g style="cursor:pointer;" transform="matrix(1,0,0,1,255,15)" control-node-menu-id="{id}">' +
                '<rect x="-4" y="-4" fill="#000000" fill-opacity="0" width="30" height="30"></rect>' +
                '<circle cx="0" cy="0" r="3" fill="#757575"></circle>' +
                '<circle cx="10" cy="0" r="3" fill="#757575"></circle>' +
                '<circle cx="20" cy="0" r="3" fill="#757575"></circle>' +
                '</g>';
            OrgChart.templates.couple_male.field_0 = 
                '<text style="font-size:14px;" fill="#2D2D2D" x="70" y="30" text-anchor="middle">{val}</text>';
            OrgChart.templates.couple_male.field_1 = 
                '<text style="font-size:12px;" fill="#5B5B5B" x="70" y="50" text-anchor="middle">{val}</text>';
            OrgChart.templates.couple_male.field_2 = 
                '<text style="font-size:14px;" fill="#2D2D2D" x="210" y="30" text-anchor="middle">{val}</text>';
            OrgChart.templates.couple_male.field_3 = 
                '<text style="font-size:12px;" fill="#5B5B5B" x="210" y="50" text-anchor="middle">{val}</text>';
            OrgChart.templates.couple_male.img_0 = 
                '<clipPath id="personClip_{id}"><circle cx="70" cy="80" r="25"></circle></clipPath>' +
                '<image preserveAspectRatio="xMidYMid slice" clip-path="url(#personClip_{id})" xlink:href="{val}" x="45" y="55" width="50" height="50"></image>';
            OrgChart.templates.couple_male.img_1 = 
                '<clipPath id="spouseClip_{id}"><circle cx="210" cy="80" r="25"></circle></clipPath>' +
                '<image preserveAspectRatio="xMidYMid slice" clip-path="url(#spouseClip_{id})" xlink:href="{val}" x="185" y="55" width="50" height="50"></image>';

            // Tùy chỉnh template cho node vợ chồng khi người con trong gia phả là nữ
            OrgChart.templates.couple_female = {};
            OrgChart.templates.couple_female.size = [280, 120];
            OrgChart.templates.couple_female.node = 
                '<rect x="0" y="0" width="280" height="120" rx="5" ry="5" fill="#ffffff" stroke-width="3" stroke="#e91e63"></rect>' +
                '<line x1="140" y1="0" x2="140" y2="120" stroke="#E4E4E4" stroke-width="1"></line>';
            OrgChart.templates.couple_female.nodeMenuButton = 
                '<g style="cursor:pointer;" transform="matrix(1,0,0,1,255,15)" control-node-menu-id="{id}">' +
                '<rect x="-4" y="-4" fill="#000000" fill-opacity="0" width="30" height="30"></rect>' +
                '<circle cx="0" cy="0" r="3" fill="#757575"></circle>' +
                '<circle cx="10" cy="0" r="3" fill="#757575"></circle>' +
                '<circle cx="20" cy="0" r="3" fill="#757575"></circle>' +
                '</g>';
            OrgChart.templates.couple_female.field_0 = 
                '<text style="font-size:14px;" fill="#2D2D2D" x="70" y="30" text-anchor="middle">{val}</text>';
            OrgChart.templates.couple_female.field_1 = 
                '<text style="font-size:12px;" fill="#5B5B5B" x="70" y="50" text-anchor="middle">{val}</text>';
            OrgChart.templates.couple_female.field_2 = 
                '<text style="font-size:14px;" fill="#2D2D2D" x="210" y="30" text-anchor="middle">{val}</text>';
            OrgChart.templates.couple_female.field_3 = 
                '<text style="font-size:12px;" fill="#5B5B5B" x="210" y="50" text-anchor="middle">{val}</text>';
            OrgChart.templates.couple_female.img_0 = 
                '<clipPath id="personClip_{id}"><circle cx="70" cy="80" r="25"></circle></clipPath>' +
                '<image preserveAspectRatio="xMidYMid slice" clip-path="url(#personClip_{id})" xlink:href="{val}" x="45" y="55" width="50" height="50"></image>';
            OrgChart.templates.couple_female.img_1 = 
                '<clipPath id="spouseClip_{id}"><circle cx="210" cy="80" r="25"></circle></clipPath>' +
                '<image preserveAspectRatio="xMidYMid slice" clip-path="url(#spouseClip_{id})" xlink:href="{val}" x="185" y="55" width="50" height="50"></image>';

            const chart = new OrgChart(document.getElementById("family-tree"), {
                template: "olivia",
                enableSearch: false,
                enableDragDrop: false,
                orientation: OrgChart.orientation.top,
                nodeBinding: {
                    // Ràng buộc chung cho tất cả các node
                    field_0: "name",
                    field_1: "birth",
                    img_0: "img",
                    
                    // Ràng buộc đặc biệt cho node vợ chồng
                    field_2: "spouseName",
                    field_3: "spouseBirth",
                    img_1: "spouseImg"
                },
                nodeMenu: {
                    details: { text: "Chi tiết" }
                },
                nodes: formattedData.nodes,
                tags: {
                    male: {
                        template: "single_male",
                        nodeMenu: {
                            details: { text: "Chi tiết" }
                        }
                    },
                    female: {
                        template: "single_female",
                        nodeMenu: {
                            details: { text: "Chi tiết" }
                        }
                    },
                    couple: {
                        template: "couple",
                        nodeMenu: {
                            details: { text: "Chi tiết" }
                        }
                    }
                },
                // Cấu hình hiển thị
                levelSeparation: 100,
                siblingSeparation: 50,
                subtreeSeparation: 80
            });

            // Xử lý sự kiện khi click vào node
            chart.on('click', function(sender, args) {
                if (args.node) {
                    // Nếu là node vợ chồng, xác định vị trí click để quyết định hiển thị ai
                    if (args.node.tags && args.node.tags.indexOf('couple') != -1) {
                        const x = args.event.offsetX;
                        const nodeX = args.node.x;
                        
                        // Tính vị trí tương đối trong node
                        const relativeX = x - nodeX;
                        
                        if (relativeX < 140) {
                            // Click vào bên trái (người chồng/vợ thứ nhất)
                            showPersonDetail(args.node.personId);
                        } else {
                            // Click vào bên phải (người vợ/chồng)
                            showPersonDetail(args.node.spouseId);
                        }
                    } else {
                        // Nếu là node đơn, sử dụng personId nếu có, không thì dùng id
                        const personId = args.node.personId || args.node.id;
                        showPersonDetail(personId);
                    }
                }
                return false; // Ngăn hành vi mặc định
            });

            // Xử lý sự kiện khi click vào menu chi tiết
            chart.on('details', function(sender, args) {
                // Luôn hiển thị chi tiết của người trong gia phả (personId)
                const personId = args.node.personId || args.node.id;
                showPersonDetail(personId);
                return false;
            });

            return chart;
        }

        // Hiển thị chi tiết một người
        function showPersonDetail(personId) {
            const person = familyData.find(p => p.id === personId);

            if (!person) {
                return;
            }

            const modal = document.getElementById('person-detail-modal');
            const contentContainer = document.getElementById('person-detail-content');

            // Tính tuổi hoặc năm sống
            let lifespan = '';
            if (person.birthDate) {
                const birthYear = new Date(person.birthDate).getFullYear();
                if (person.deathDate) {
                    const deathYear = new Date(person.deathDate).getFullYear();
                    lifespan = `${birthYear} - ${deathYear}`;
                } else {
                    lifespan = `Sinh năm ${birthYear}`;
                }
            }

            // Ảnh đại diện theo giới tính
            let photoUrl = person.photo;
            if (!photoUrl) {
                if (person.gender === 'male') {
                    photoUrl = 'https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_1280.png';
                } else {
                    photoUrl = 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png';
                }
            }

            // Tìm thông tin cha mẹ
            let parentsHTML = '<p>Không có thông tin</p>';
            if (person.parents && person.parents.length > 0) {
                parentsHTML = '<div class="relation-list">';
                person.parents.forEach(parentId => {
                    const parentData = familyData.find(p => p.id === parentId);
                    if (parentData) {
                        parentsHTML += `
                            <div class="relation-item">
                                ${parentData.name} (${parentData.gender === 'male' ? 'Cha' : 'Mẹ'})
                            </div>
                        `;
                    }
                });
                parentsHTML += '</div>';
            }

            // Tìm thông tin vợ/chồng
            let spousesHTML = '<p>Không có thông tin</p>';
            if (person.spouses && person.spouses.length > 0) {
                spousesHTML = '<div class="relation-list">';
                person.spouses.forEach(spouseId => {
                    const spouseData = familyData.find(p => p.id === spouseId);
                    if (spouseData) {
                        spousesHTML += `
                            <div class="relation-item">
                                ${spouseData.name} (${spouseData.gender === 'male' ? 'Chồng' : 'Vợ'})
                            </div>
                        `;
                    }
                });
                spousesHTML += '</div>';
            }

            // Tìm thông tin con cái
            let childrenHTML = '<p>Không có thông tin</p>';
            if (person.children && person.children.length > 0) {
                childrenHTML = '<div class="relation-list">';
                person.children.forEach(childId => {
                    const childData = familyData.find(p => p.id === childId);
                    if (childData) {
                        childrenHTML += `
                            <div class="relation-item">
                                ${childData.name} (${childData.gender === 'male' ? 'Con trai' : 'Con gái'})
                            </div>
                        `;
                    }
                });
                childrenHTML += '</div>';
            }

            // Tạo nội dung chi tiết người
            contentContainer.innerHTML = `
                <div class="person-detail-header">
                    <img src="${photoUrl}" alt="${person.name}" class="node-image">
                    <div class="person-detail-info">
                        <h2 class="person-detail-name">${person.name}</h2>
                        <p class="person-detail-dates">${lifespan}</p>
                        <p>Thế hệ: ${person.generation}</p>
                        <p>Giới tính: ${person.gender === 'male' ? 'Nam' : 'Nữ'}</p>
                    </div>
                </div>
                
                <div class="person-detail-section">
                    <h3>Cha mẹ</h3>
                    ${parentsHTML}
                </div>
                
                <div class="person-detail-section">
                    <h3>Vợ/Chồng</h3>
                    ${spousesHTML}
                </div>
                
                <div class="person-detail-section">
                    <h3>Con cái</h3>
                    ${childrenHTML}
                </div>
            `;

            // Hiển thị modal
            modal.style.display = 'block';
        }

        // Thiết lập sự kiện cho modal
        function setupModalEvents() {
            const modal = document.getElementById('person-detail-modal');
            const closeBtn = document.getElementById('close-modal');

            // Đóng modal khi nhấp vào nút đóng
            closeBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });

            // Đóng modal khi nhấp vào bên ngoài
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Sự kiện khi tài liệu đã tải xong
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Hiển thị loading indicator
                document.getElementById('loading-indicator').style.display = 'block';

                // Lấy dữ liệu gia phả
                familyData = await getFamilyData();

                // Kiểm tra xem có dữ liệu không
                if (familyData.length === 0) {
                    document.getElementById('loading-indicator').style.display = 'none';
                    document.getElementById('empty-state').style.display = 'block';
                    return;
                }

                // Chuyển đổi dữ liệu cho OrgChart.js
                const formattedData = convertToOrgChartFormat(familyData);
                
                // Khởi tạo OrgChart
                document.getElementById('family-tree-container').style.display = 'block';
                familyChart = initializeOrgChart(formattedData);

                // Ẩn loading indicator
                document.getElementById('loading-indicator').style.display = 'none';

                // Thiết lập sự kiện cho modal
                setupModalEvents();
            } catch (error) {
                console.error('Lỗi khi hiển thị cây gia phả:', error);
                document.getElementById('loading-indicator').style.display = 'none';

                const errorMessage = document.createElement('p');
                errorMessage.style.textAlign = 'center';
                errorMessage.style.padding = '40px 0';
                errorMessage.style.color = '#e74c3c';
                errorMessage.textContent = `Lỗi khi tải dữ liệu gia phả: ${error.message}`;
                document.getElementById('family-tree-container').appendChild(errorMessage);
                document.getElementById('family-tree-container').style.display = 'block';
            }
        });
    </script>
</body>
</html>