<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
    <title>Gia phả dòng họ Nguyễn Bá - xã Hoàng Sơn, huyện Nông Cống, tỉnh Thanh Hóa</title>
    <link rel="stylesheet" href="family-tree.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Thư viện OrgChart.js -->
    <script src="js/OrgChart.js"></script>

    <style>
        #family-tree-container {
            width: 100%;
            height: 700px;
            overflow: hidden;
            position: relative;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        
        /* CSS cho Node */
        .family-node {
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            background-color: white;
            transition: all 0.3s ease;
        }
        
        .family-node.male {
            border-left: 5px solid #0066cc;
        }
        
        .family-node.female {
            border-left: 5px solid #e91e63;
        }
        
        .node-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 8px;
            border: 3px solid #f0f5ff;
        }
        
        /* Tùy chỉnh cho modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }
        
        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 10px;
        }
        
        .close-modal:hover {
            color: black;
        }
        
        .loading-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
        }
        
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tùy chỉnh giao diện OrgChart */
        [data-boc-name] {
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }
        
        [data-boc-birth] {
            font-size: 12px;
            color: #666;
        }
        
        .relation-list {
            margin: 10px 0;
        }
        
        .relation-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .view-details-btn {
            display: inline-block;
            margin-top: 5px;
            font-size: 12px;
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
        }
        
        /* Tùy chỉnh đường kết nối vợ chồng */
        [data-boc-layout-path-line-marriage] {
            stroke: #FF9999;
            stroke-width: 2px;
            stroke-dasharray: 4;
        }
        
        /* Ẩn node kết nối giữa vợ chồng */
        [data-boc-tags~=partner-connection] {
            opacity: 0;
        }
        
        /* Tăng khoảng cách giữa vợ chồng */
        .partner-node {
            margin: 0 15px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="navigation-menu">
                    <a href="index.html" class="nav-item">Trang chủ</a>
                    <a href="family-tree.html" class="nav-item active">Gia phả</a>
                    <a href="all-posts.html" class="nav-item">Tất cả bài viết</a>
                </div>

                <div class="author-info">
                    <div class="avatar-container">
                        <img src="profile3.jpg" alt="Avatar" class="avatar-img">
                    </div>
                    <div class="author-text-content">
                        <p class="author-title">Chào mừng bạn đến với website gia phả họ Nguyễn Bá</p>

                        <div class="social-links">
                            <a href="https://www.facebook.com/tungnb/" class="social-btn social-tooltip" title="Facebook">
                                <i class="fab fa-facebook-f"></i>
                                <span class="tooltip-text">Facebook</span>
                            </a>

                            <a href="mailto:tungnguyen@mayhoangtung.com" class="social-btn social-tooltip" title="Email">
                                <i class="fas fa-envelope"></i>
                                <span class="tooltip-text">tungnguyen@mayhoangtung.com</span>
                            </a>

                            <a href="tel:0983887485" class="social-btn social-tooltip" title="Điện thoại">
                                <i class="fas fa-phone"></i>
                                <span class="tooltip-text">0983887485</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <section class="content">
        <div class="container">
            <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Quay lại trang chủ</a>

            <div id="loading-indicator" class="loading-indicator">
                <div class="loading-spinner"></div>
                <p>Đang tải dữ liệu gia phả...</p>
            </div>

            <div id="family-tree-container" class="family-tree-container" style="display: none">
                <div id="family-tree" class="chart"></div>
            </div>

            <div id="empty-state" class="empty-state" style="display: none">
                <i class="fas fa-users-slash"></i>
                <h3>Chưa có dữ liệu gia phả</h3>
                <p>Dữ liệu gia phả đang được cập nhật. Vui lòng quay lại sau.</p>
            </div>
        </div>
    </section>

    <div id="person-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="close-modal">&times;</span>
            <div id="person-detail-content">
                <!-- Chi tiết người sẽ được thêm vào đây -->
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <p class="copyright">Tạo vào © 2025 Nguyễn Bá Tùng</p>
            </div>
        </div>
    </footer>

    <script>
        // Thiết lập cấu trúc dữ liệu cho gia phả
        let familyData = [];
        let familyChart = null;

        // Lấy dữ liệu gia phả từ API hoặc dữ liệu mẫu
        async function getFamilyData() {
            try {
                console.log("Đang gọi API để lấy dữ liệu gia phả...");
                
                // Thêm timeout cho API call để tránh chờ quá lâu
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 giây timeout
                
                try {
                    const response = await fetch('/api/family', {
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`Lỗi khi lấy dữ liệu: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log(`Đã nhận ${data.length} người từ API`);
                    return data;
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    
                    // Nếu lỗi là do timeout hoặc network, hiển thị thông báo rõ ràng hơn
                    if (fetchError.name === 'AbortError') {
                        console.warn('API timeout sau 10 giây. Sử dụng dữ liệu mẫu.');
                        throw new Error('Kết nối API quá chậm. Đang sử dụng dữ liệu mẫu.');
                    } else {
                        console.warn('Lỗi khi gọi API:', fetchError.message);
                        throw fetchError;
                    }
                }
            } catch (error) {
                console.warn('Sử dụng dữ liệu mẫu do lỗi:', error.message);

                // Trả về dữ liệu mẫu đã có
                return [
                    {
                        id: '1',
                        name: 'Nguyễn Bá Cụ',
                        gender: 'male',
                        generation: 1,
                        birthDate: '1900-01-01',
                        deathDate: '1970-01-01',
                        spouses: ['100'],
                        children: ['2', '3', '4']
                    },
                    {
                        id: '100',
                        name: 'Nguyễn Thị Vợ Cụ',
                        gender: 'female',
                        generation: 1,
                        birthDate: '1905-01-01',
                        deathDate: '1975-01-01',
                        spouses: ['1'],
                        children: ['2', '3', '4']
                    },
                    {
                        id: '2',
                        name: 'Nguyễn Bá Trưởng',
                        gender: 'male',
                        generation: 2,
                        birthDate: '1930-01-01',
                        parents: ['1', '100'],
                        spouses: ['101'],
                        children: ['5', '6']
                    },
                    {
                        id: '101',
                        name: 'Nguyễn Thị Vợ Trưởng',
                        gender: 'female',
                        generation: 2,
                        birthDate: '1935-01-01',
                        spouses: ['2'],
                        children: ['5', '6']
                    },
                    {
                        id: '3',
                        name: 'Nguyễn Bá Thứ',
                        gender: 'male',
                        generation: 2,
                        birthDate: '1935-01-01',
                        parents: ['1', '100'],
                        spouses: ['102'],
                        children: ['7']
                    },
                    {
                        id: '102',
                        name: 'Nguyễn Thị Vợ Thứ',
                        gender: 'female',
                        generation: 2,
                        birthDate: '1940-01-01',
                        spouses: ['3'],
                        children: ['7']
                    },
                    {
                        id: '4',
                        name: 'Nguyễn Bá Út',
                        gender: 'male',
                        generation: 2,
                        birthDate: '1940-01-01',
                        parents: ['1', '100'],
                        spouses: ['103'],
                        children: ['8', '9']
                    },
                    {
                        id: '103',
                        name: 'Nguyễn Thị Vợ Út',
                        gender: 'female',
                        generation: 2,
                        birthDate: '1945-01-01',
                        spouses: ['4'],
                        children: ['8', '9']
                    },
                    {
                        id: '5',
                        name: 'Nguyễn Bá A',
                        gender: 'male',
                        generation: 3,
                        birthDate: '1960-01-01',
                        parents: ['2', '101']
                    },
                    {
                        id: '6',
                        name: 'Nguyễn Thị B',
                        gender: 'female',
                        generation: 3,
                        birthDate: '1965-01-01',
                        parents: ['2', '101']
                    },
                    {
                        id: '7',
                        name: 'Nguyễn Bá C',
                        gender: 'male',
                        generation: 3,
                        birthDate: '1965-01-01',
                        parents: ['3', '102']
                    },
                    {
                        id: '8',
                        name: 'Nguyễn Bá D',
                        gender: 'male',
                        generation: 3,
                        birthDate: '1970-01-01',
                        parents: ['4', '103']
                    },
                    {
                        id: '9',
                        name: 'Nguyễn Thị E',
                        gender: 'female',
                        generation: 3,
                        birthDate: '1975-01-01',
                        parents: ['4', '103']
                    }
                ];
            }
        }

        // Chuyển đổi cấu trúc dữ liệu cho OrgChart.js
        function convertToOrgChartFormat(familyDataArray) {
            // OrgChart.js cần định dạng mảng các nút với các thuộc tính id, pid, v.v.
            const nodes = [];
            const relationshipsMap = new Map(); // Lưu trữ các mối quan hệ vợ chồng

            familyDataArray.forEach(person => {
                // Ảnh đại diện theo giới tính
                let photoUrl = person.photo;
                if (!photoUrl) {
                    if (person.gender === 'male') {
                        photoUrl = 'https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_1280.png';
                    } else {
                        photoUrl = 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png';
                    }
                }

                // Tạo chuỗi hiển thị ngày sinh, ngày mất
                let lifespan = '';
                if (person.birthDate) {
                    const birthYear = new Date(person.birthDate).getFullYear();
                    if (person.deathDate) {
                        const deathYear = new Date(person.deathDate).getFullYear();
                        lifespan = `${birthYear} - ${deathYear}`;
                    } else {
                        lifespan = `Sinh năm ${birthYear}`;
                    }
                }

                // Chuyển đổi thành định dạng node của OrgChart.js
                const node = {
                    id: person.id,
                    name: person.name,
                    img: photoUrl,
                    birth: lifespan,
                    gender: person.gender,
                    generation: person.generation,
                    tags: [person.gender]
                };

                // Thiết lập quan hệ cha mẹ - con
                if (person.parents && person.parents.length > 0) {
                    // Nếu có cả cha và mẹ, sử dụng cha làm pid
                    node.pid = person.parents[0];

                    // Nếu có cả cha và mẹ, lưu thông tin về mối quan hệ vợ chồng
                    if (person.parents.length >= 2) {
                        const coupleId = person.parents.sort().join('_');
                        
                        if (!relationshipsMap.has(coupleId)) {
                            relationshipsMap.set(coupleId, {
                                partnerId1: person.parents[0],
                                partnerId2: person.parents[1]
                            });
                        }
                    }
                }

                // Lưu thông tin vợ/chồng để tạo mối quan hệ sau
                if (person.spouses && person.spouses.length > 0) {
                    person.spouses.forEach(spouseId => {
                        const coupleId = [person.id, spouseId].sort().join('_');
                        
                        if (!relationshipsMap.has(coupleId)) {
                            relationshipsMap.set(coupleId, {
                                partnerId1: person.id,
                                partnerId2: spouseId
                            });
                        }
                    });
                }

                nodes.push(node);
            });

            return {
                nodes: nodes,
                relationships: Array.from(relationshipsMap.values())
            };
        }

        // Hàm khởi tạo OrgChart
        function initializeOrgChart(formattedData) {
            const chart = new OrgChart(document.getElementById("family-tree"), {
                template: "olivia",
                enableSearch: false,
                enableDragDrop: false,
                orientation: OrgChart.orientation.top,
                nodeBinding: {
                    field_0: "name",
                    field_1: "birth",
                    img_0: "img"
                },
                nodeMenu: {
                    details: { text: "Chi tiết" }
                },
                nodes: formattedData.nodes,
                tags: {
                    male: {
                        template: "olivia",
                        nodeMenu: {
                            details: { text: "Chi tiết" }
                        }
                    },
                    female: {
                        template: "mila",
                        nodeMenu: {
                            details: { text: "Chi tiết" }
                        }
                    },
                    partner: {
                        template: "olivia"
                    }
                },
                // Cấu hình hiển thị vợ chồng ngang hàng
                levelSeparation: 100,
                siblingSeparation: 50,
                subtreeSeparation: 80,
                partnerChildrenSplitSeparation: 20,
                partnerNodeSeparation: 30,
                // Cấu hình hiển thị mối quan hệ vợ chồng
                marriage: {
                    template: 'wedding', // Template cho đường kết nối vợ chồng
                    calloutTooltip: 'Vợ/Chồng'
                }
            });

            // Thêm các mối quan hệ vợ chồng với cấu hình ngang hàng
            formattedData.relationships.forEach(relation => {
                // Tạo mối quan hệ vợ chồng với type: partner để hiển thị ngang hàng
                chart.addPartnerAndParentNodes({
                    id: relation.partnerId1 + "_" + relation.partnerId2,
                    partnerId: relation.partnerId1,
                    partnerParentId: relation.partnerId2,
                    templateName: "partner"
                });
            });

            // Xử lý sự kiện khi click vào node
            chart.on('click', function(sender, args) {
                if (args.node) {
                    showPersonDetail(args.node.id);
                }
                return false; // Ngăn hành vi mặc định
            });

            // Xử lý sự kiện khi click vào menu chi tiết
            chart.on('details', function(sender, args) {
                showPersonDetail(args.node.id);
                return false;
            });

            return chart;
        }

        // Hiển thị chi tiết một người
        function showPersonDetail(personId) {
            const person = familyData.find(p => p.id === personId);

            if (!person) {
                return;
            }

            const modal = document.getElementById('person-detail-modal');
            const contentContainer = document.getElementById('person-detail-content');

            // Tính tuổi hoặc năm sống
            let lifespan = '';
            if (person.birthDate) {
                const birthYear = new Date(person.birthDate).getFullYear();
                if (person.deathDate) {
                    const deathYear = new Date(person.deathDate).getFullYear();
                    lifespan = `${birthYear} - ${deathYear}`;
                } else {
                    lifespan = `Sinh năm ${birthYear}`;
                }
            }

            // Ảnh đại diện theo giới tính
            let photoUrl = person.photo;
            if (!photoUrl) {
                if (person.gender === 'male') {
                    photoUrl = 'https://cdn.pixabay.com/photo/2016/08/08/09/17/avatar-1577909_1280.png';
                } else {
                    photoUrl = 'https://cdn-icons-png.flaticon.com/512/6997/6997662.png';
                }
            }

            // Tìm thông tin cha mẹ
            let parentsHTML = '<p>Không có thông tin</p>';
            if (person.parents && person.parents.length > 0) {
                parentsHTML = '<div class="relation-list">';
                person.parents.forEach(parentId => {
                    const parentData = familyData.find(p => p.id === parentId);
                    if (parentData) {
                        parentsHTML += `
                            <div class="relation-item">
                                ${parentData.name} (${parentData.gender === 'male' ? 'Cha' : 'Mẹ'})
                            </div>
                        `;
                    }
                });
                parentsHTML += '</div>';
            }

            // Tìm thông tin vợ/chồng
            let spousesHTML = '<p>Không có thông tin</p>';
            if (person.spouses && person.spouses.length > 0) {
                spousesHTML = '<div class="relation-list">';
                person.spouses.forEach(spouseId => {
                    const spouseData = familyData.find(p => p.id === spouseId);
                    if (spouseData) {
                        spousesHTML += `
                            <div class="relation-item">
                                ${spouseData.name} (${spouseData.gender === 'male' ? 'Chồng' : 'Vợ'})
                            </div>
                        `;
                    }
                });
                spousesHTML += '</div>';
            }

            // Tìm thông tin con cái
            let childrenHTML = '<p>Không có thông tin</p>';
            if (person.children && person.children.length > 0) {
                childrenHTML = '<div class="relation-list">';
                person.children.forEach(childId => {
                    const childData = familyData.find(p => p.id === childId);
                    if (childData) {
                        childrenHTML += `
                            <div class="relation-item">
                                ${childData.name} (${childData.gender === 'male' ? 'Con trai' : 'Con gái'})
                            </div>
                        `;
                    }
                });
                childrenHTML += '</div>';
            }

            // Tạo nội dung chi tiết người
            contentContainer.innerHTML = `
                <div class="person-detail-header">
                    <img src="${photoUrl}" alt="${person.name}" class="node-image">
                    <div class="person-detail-info">
                        <h2 class="person-detail-name">${person.name}</h2>
                        <p class="person-detail-dates">${lifespan}</p>
                        <p>Thế hệ: ${person.generation}</p>
                        <p>Giới tính: ${person.gender === 'male' ? 'Nam' : 'Nữ'}</p>
                    </div>
                </div>
                
                <div class="person-detail-section">
                    <h3>Cha mẹ</h3>
                    ${parentsHTML}
                </div>
                
                <div class="person-detail-section">
                    <h3>Vợ/Chồng</h3>
                    ${spousesHTML}
                </div>
                
                <div class="person-detail-section">
                    <h3>Con cái</h3>
                    ${childrenHTML}
                </div>
            `;

            // Hiển thị modal
            modal.style.display = 'block';
        }

        // Thiết lập sự kiện cho modal
        function setupModalEvents() {
            const modal = document.getElementById('person-detail-modal');
            const closeBtn = document.getElementById('close-modal');

            // Đóng modal khi nhấp vào nút đóng
            closeBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });

            // Đóng modal khi nhấp vào bên ngoài
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Sự kiện khi tài liệu đã tải xong
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Hiển thị loading indicator
                document.getElementById('loading-indicator').style.display = 'block';

                // Lấy dữ liệu gia phả
                familyData = await getFamilyData();

                // Kiểm tra xem có dữ liệu không
                if (familyData.length === 0) {
                    document.getElementById('loading-indicator').style.display = 'none';
                    document.getElementById('empty-state').style.display = 'block';
                    return;
                }

                // Chuyển đổi dữ liệu cho OrgChart.js
                const formattedData = convertToOrgChartFormat(familyData);
                
                // Khởi tạo OrgChart
                document.getElementById('family-tree-container').style.display = 'block';
                familyChart = initializeOrgChart(formattedData);

                // Ẩn loading indicator
                document.getElementById('loading-indicator').style.display = 'none';

                // Thiết lập sự kiện cho modal
                setupModalEvents();
            } catch (error) {
                console.error('Lỗi khi hiển thị cây gia phả:', error);
                document.getElementById('loading-indicator').style.display = 'none';

                const errorMessage = document.createElement('p');
                errorMessage.style.textAlign = 'center';
                errorMessage.style.padding = '40px 0';
                errorMessage.style.color = '#e74c3c';
                errorMessage.textContent = `Lỗi khi tải dữ liệu gia phả: ${error.message}`;
                document.getElementById('family-tree-container').appendChild(errorMessage);
                document.getElementById('family-tree-container').style.display = 'block';
            }
        });
    </script>
</body>
</html>